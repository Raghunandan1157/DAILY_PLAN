<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NLPL OrgPortal</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Light Theme Defaults */
            --bg-body: #F4F5F9;
            --bg-card: #FFFFFF;
            --bg-sidebar: #FFFFFF;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --primary-accent: #5B5CEB;
            --primary-light: #EEF2FF;
            --success: #10B981;
            --success-light: #D1FAE5;
            --warning: #F59E0B;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --sidebar-width: 260px;
        }

        body.dark-mode {
            --bg-body: #1F2029;
            --bg-card: #252836;
            --bg-sidebar: #252836;
            --text-primary: #FFFFFF;
            --text-secondary: #9CA3AF;
            --border-color: #374151;
            --primary-accent: #6366F1;
            --primary-light: rgba(99, 102, 241, 0.1);
            --success: #34D399;
            --success-light: rgba(52, 211, 153, 0.1);
            --warning: #FBBF24;
            --card-shadow: none;
        }

        * {
            box-sizing: border-box;
            outline: none;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        button:active {
            transform: scale(0.98);
        }

        .date-btn {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 20px 24px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .date-btn:hover {
            border-color: var(--primary-accent);
            background: var(--bg-body);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .date-btn:active {
            transform: scale(0.98);
        }

        .db-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .db-date {
            font-size: 18px;
            color: var(--text-primary);
            font-weight: 700;
        }

        /* --- UTILITIES --- */
        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-2 {
            gap: 8px;
        }

        .gap-4 {
            gap: 16px;
        }

        button {
            font-family: inherit;
            cursor: pointer;
        }

        /* --- ICONS (SVG) --- */
        .icon {
            width: 20px;
            height: 20px;
            stroke-width: 2;
            stroke: currentColor;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* --- LAYOUT --- */

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 24px;
            transition: background 0.3s;
            z-index: 20;
        }

        .brand {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-accent);
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 40px;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .nav-item:hover,
        .nav-item.active {
            background: var(--primary-light);
            color: var(--primary-accent);
        }

        .support-card {
            background: var(--primary-light);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            margin-top: auto;
        }

        .support-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-accent);
            margin-bottom: 4px;
        }

        .support-text {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .btn-support {
            background: var(--primary-accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .btn-support:hover {
            opacity: 0.9;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* Top Header */
        .top-header {
            height: 70px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            transition: background 0.3s;
        }

        /* Hamburger Menu (Mobile Only) */
        .hamburger-btn {
            display: none;
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px;
            margin-right: 12px;
        }

        .sidebar-overlay {
            display: none;
            /* Hide on desktop */
        }

        .breadcrumbs {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .breadcrumbs span {
            color: var(--text-primary);
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .date-picker {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-body);
            border-radius: 8px;
            font-size: 13px;
            color: var(--text-primary);
            font-weight: 500;
            position: relative;
            transition: all 0.2s;
        }

        .date-picker:hover {
            background: var(--primary-light);
            color: var(--primary-accent);
        }

        /* Date Range Dropdown Styles */
        .date-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 280px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            padding: 16px;
        }

        .date-dropdown.hidden {
            display: none;
        }

        .date-dropdown-header {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .date-quick-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .date-quick-btn {
            flex: 1;
            padding: 10px 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-body);
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .date-quick-btn:hover {
            background: var(--primary-light);
            border-color: var(--primary-accent);
            color: var(--primary-accent);
        }

        .date-quick-btn.active {
            background: var(--primary-accent);
            border-color: var(--primary-accent);
            color: white;
        }

        .date-range-divider {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
            margin: 12px 0;
            position: relative;
        }

        .date-range-divider::before,
        .date-range-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 30%;
            height: 1px;
            background: var(--border-color);
        }

        .date-range-divider::before {
            left: 0;
        }

        .date-range-divider::after {
            right: 0;
        }

        .date-range-inputs {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .date-input-group {
            flex: 1;
        }

        .date-input-group label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .date-input-group input[type="date"] {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 12px;
            background: var(--bg-body);
            color: var(--text-primary);
        }

        .date-input-group input[type="date"]:focus {
            outline: none;
            border-color: var(--primary-accent);
        }

        .date-apply-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, var(--primary-accent) 0%, #6366F1 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .date-apply-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .date-apply-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Calendar Grid Styles */
        .calendar-container {
            margin-bottom: 12px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            margin-bottom: 8px;
        }

        .calendar-header span {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .calendar-nav-btn {
            background: var(--bg-body);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .calendar-nav-btn:hover {
            background: var(--primary-light);
            border-color: var(--primary-accent);
            color: var(--primary-accent);
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            margin-bottom: 4px;
        }

        .calendar-weekdays span {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 4px 0;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            color: var(--text-primary);
            background: transparent;
            border: 2px solid transparent;
        }

        .calendar-day:hover {
            background: var(--primary-light);
            border-color: var(--primary-accent);
        }

        .calendar-day.other-month {
            color: var(--text-secondary);
            opacity: 0.5;
        }

        .calendar-day.today {
            background: #EF4444;
            color: white;
            font-weight: 700;
        }

        .calendar-day.today:hover {
            background: #DC2626;
            border-color: #DC2626;
        }

        .calendar-day.selected {
            background: var(--primary-accent);
            color: white;
            font-weight: 600;
            border-color: var(--primary-accent);
        }

        .calendar-day.in-range {
            background: var(--primary-light);
        }

        /* Updated Quick Button Styles */
        .date-quick-btn {
            flex: 1;
            padding: 12px 8px;
            border: 2px solid var(--border-color);
            background: var(--bg-body);
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .date-quick-btn .btn-icon {
            font-size: 18px;
        }

        .date-quick-btn:hover {
            background: var(--primary-light);
            border-color: var(--primary-accent);
            color: var(--primary-accent);
        }

        .date-quick-btn.active {
            background: var(--primary-light);
            border-color: var(--primary-accent);
            color: var(--primary-accent);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 8px;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .theme-toggle:hover {
            background: var(--bg-body);
            color: var(--primary-accent);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-left: 20px;
            border-left: 1px solid var(--border-color);
        }

        .avatar {
            width: 36px;
            height: 36px;
            background: var(--primary-accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-size: 13px;
            font-weight: 600;
        }

        .user-role {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Dashboard Area */
        .dashboard-container {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .fade-enter {
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }


        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            /* 4 Columns */
            gap: 24px;
            margin-bottom: 30px;
        }

        /* Full Width for Tables/Tree */
        .grid-full {
            grid-column: span 4;
        }

        .grid-half {
            grid-column: span 2;
        }

        /* Metric Card */
        .metric-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            gap: 12px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .metric-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: var(--primary-light);
            color: var(--primary-accent);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .metric-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 26px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .metric-badge {
            font-size: 11px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .badge-up {
            background: var(--success-light);
            color: var(--success);
        }

        /* Chart Card */
        .chart-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            min-height: 320px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* CSS Bar Chart */
        .bar-chart-container {
            flex: 1;
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 12px;
            padding-bottom: 20px;
            position: relative;
        }

        .bar-group {
            flex: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            gap: 8px;
        }

        .bar {
            width: 100%;
            max-width: 40px;
            background: linear-gradient(180deg, var(--primary-accent) 0%, rgba(91, 92, 235, 0.6) 100%);
            border-radius: 4px 4px 0 0;
            transition: height 0.6s ease;
            min-height: 4px;
        }

        .bar-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
        }

        /* Table Card */
        .table-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 16px;
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-color);
        }

        td {
            padding: 16px;
            font-size: 14px;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }

        tr:last-child td {
            border-bottom: none;
        }

        .status-pill {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-active {
            background: var(--success-light);
            color: var(--success);
        }

        .status-pending {
            background: var(--primary-light);
            color: var(--primary-accent);
        }

        /* Login Overlay */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-body);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }

        #daily-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 200;
            /* Above login */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
            overflow-y: auto;
            padding: 20px;
        }

        .overlay-time {
            font-size: 80px;
            font-weight: 300;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .overlay-date {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary-accent);
            margin-bottom: 60px;
        }

        .date-buttons-container {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .overlay-hint {
            margin-top: 24px;
            color: var(--text-secondary);
            font-size: 12px;
        }


        .login-box {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .login-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .login-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            transition: 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-accent);
            color: white;
            box-shadow: 0 4px 10px rgba(91, 92, 235, 0.3);
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            background: var(--bg-body);
        }

        select {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-body);
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        /* TOAST NOTIFICATION */
        #toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            padding: 12px 24px;
            border-radius: 50px;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
            font-weight: 500;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 200;
        }

        #toast.visible {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        #toast svg {
            color: var(--success);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* --- READ ONLY MODE --- */
        .read-only-mode .form-section {
            background: var(--success-light);
            border-color: var(--success);
        }

        .read-only-mode .form-input {
            background: white;
            color: var(--text-primary);
            border-color: var(--success);
            cursor: not-allowed;
        }

        .read-only-mode .modal-footer {
            display: none;
        }

        .read-only-banner {
            background: var(--success);
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        /* --- SEARCH BAR --- */
        .search-container {
            position: relative;
            width: 300px;
            margin-right: 20px;
        }

        .search-input {
            width: 100%;
            padding: 10px 16px 10px 40px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-body);
            color: var(--text-primary);
            font-size: 13px;
            transition: all 0.2s;
        }

        .search-input:focus {
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 3px var(--primary-light);
            background: var(--bg-card);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            width: 16px;
            height: 16px;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 8px;
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            z-index: 50;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .search-results.visible {
            display: block;
        }

        .search-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-item:last-child {
            border-bottom: none;
        }

        .search-item:hover {
            background: var(--bg-body);
        }

        /* --- GLOBAL LOADER --- */
        .global-loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .global-loader.visible {
            opacity: 1;
            pointer-events: all;
        }

        .loader-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--bg-card);
            border-top-color: var(--primary-accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .loader-text {
            color: white;
            font-size: 14px;
            font-weight: 500;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* --- BRANCH DETAILS MODAL --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 150;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            backdrop-filter: blur(2px);
        }

        .modal-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }

        .modal-container {
            background: var(--bg-body);
            width: 95%;
            max-width: 1200px;
            height: 90vh;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-header {
            background: var(--bg-card);
            padding: 20px 32px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--bg-body);
            color: var(--text-primary);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        .form-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .form-section-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 20px;
            letter-spacing: 0.5px;
            text-align: center;
        }

        .form-row {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-row:last-child {
            margin-bottom: 0;
        }

        .form-label {
            flex: 1;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-body);
            color: var(--text-primary);
            font-size: 13px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-input::placeholder {
            color: #9CA3AF;
        }

        .input-error {
            border-color: #EF4444 !important;
            animation: shake 0.3s cubic-bezier(.36, .07, .19, .97) both;
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        /* Helpers for Grid Layout */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .grid-2-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .target-row {
            margin-bottom: 16px;
        }

        .target-header {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 600;
        }

        .modal-footer {
            padding: 20px 32px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-card);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* --- MOBILE RESPONSIVENESS --- */
        @media (max-width: 768px) {
            :root {
                --sidebar-width: 260px;
                /* Fixed width for drawer */
            }

            /* Layout */
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                transform: translateX(-100%);
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
                transition: transform 0.3s ease-in-out;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            /* Overlay for Sidebar */
            .sidebar-overlay {
                display: block;
                /* Show on mobile (controlled by opacity) */
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 15;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s;
                backdrop-filter: blur(2px);
            }

            .sidebar-overlay.visible {
                opacity: 1;
                pointer-events: all;
            }

            .main-content {
                width: 100%;
                margin-left: 0;
            }

            .top-header {
                padding: 0 16px;
            }

            .hamburger-btn {
                display: block;
            }

            /* Hide Breadcrumbs on super small screens or truncate */
            .breadcrumbs {
                font-size: 13px;
            }

            /* Search Bar */
            .search-container {
                width: auto;
                position: static;
                /* Let it break out if needed, or keep compact */
            }

            .search-input {
                width: 36px;
                height: 36px;
                padding: 0;
                border: none;
                background: transparent;
                text-indent: -9999px;
                /* Hide text visually */
                cursor: pointer;
                position: relative;
                z-index: 5;
            }

            .search-input:focus {
                position: absolute;
                top: 70px;
                /* Below header */
                left: 16px;
                right: 16px;
                width: calc(100% - 32px);
                height: 44px;
                background: var(--bg-card);
                border: 1px solid var(--primary-accent);
                text-indent: 0;
                padding: 10px 16px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                z-index: 100;
            }

            .search-icon {
                pointer-events: none;
                /* Let clicks pass to input */
                color: var(--text-primary);
                width: 20px;
                height: 20px;
                z-index: 6;
            }

            /* When focused, move icon or hide it? simpler to just style input as a popup */

            /* Dashboard Grid */
            .dashboard-container {
                padding: 16px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                /* Stack everything */
                gap: 16px;
            }

            .grid-full,
            .grid-half {
                grid-column: span 1;
            }

            /* User Profile */
            .user-info {
                display: none;
                /* Hide name/role to save space */
            }

            .user-profile {
                padding-left: 10px;
                gap: 0;
            }

            /* Charts & Tables */
            .chart-card,
            .table-card,
            .metric-card {
                padding: 16px;
            }

            .bar-chart-container {
                overflow-x: auto;
                /* Allow scroll if too squished */
                padding-bottom: 30px;
                /* Space for scrollbar */
            }

            /* Drill Down Grid */
            #drillDownGrid {
                /* 2 columns on mobile instead of auto-fill minmax 200 which might result in 1 */
                grid-template-columns: 1fr 1fr !important;
                gap: 10px !important;
            }

            /* Modals */
            .modal-container {
                width: 100%;
                height: 100%;
                border-radius: 0;
                max-width: none;
            }

            .modal-header {
                padding: 16px;
            }

            .modal-body {
                padding: 16px;
                grid-template-columns: 1fr;
                /* Stack columns */
                display: flex;
                flex-direction: column;
            }

            .left-panel,
            .right-panel {
                gap: 16px;
            }

            .grid-2-col {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .modal-footer {
                padding: 16px;
                flex-direction: column;
            }

            .modal-footer button {
                width: 100% !important;
            }

            /* Font Sizes */
            .metric-value {
                font-size: 22px;
            }

            .login-box {
                width: 90%;
                padding: 24px;
            }
        }

        /* --- CEO DETAIL MODAL --- */
        .detail-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            backdrop-filter: blur(4px);
        }

        .detail-modal-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }

        .detail-modal-container {
            background: var(--bg-body);
            width: 95%;
            max-width: 1400px;
            height: 90vh;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 60px -12px rgba(0, 0, 0, 0.35);
            transform: scale(0.95) translateY(20px);
            transition: transform 0.3s ease;
        }

        .detail-modal-overlay.visible .detail-modal-container {
            transform: scale(1) translateY(0);
        }

        .detail-modal-header {
            background: linear-gradient(135deg, var(--primary-accent) 0%, #4F46E5 100%);
            padding: 20px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .detail-modal-title {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .detail-modal-subtitle {
            font-size: 13px;
            opacity: 0.8;
            margin-left: 12px;
        }

        .detail-modal-back {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
        }

        .detail-modal-back:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .detail-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .detail-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .detail-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
            background: var(--bg-body);
        }

        /* Detail Content Styles */
        .detail-summary-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .detail-stat-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            text-align: center;
        }

        .detail-stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .detail-stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .detail-branch-list {
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
        }

        .detail-branch-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr;
            padding: 16px 24px;
            background: var(--bg-body);
            font-size: 11px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-branch-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            transition: background 0.2s;
        }

        .detail-branch-row:hover {
            background: var(--bg-body);
        }

        .detail-branch-row:last-child {
            border-bottom: none;
        }

        .detail-branch-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .detail-branch-region {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .detail-pct-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            display: inline-block;
        }

        .detail-filter-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .detail-filter-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .detail-filter-btn:hover,
        .detail-filter-btn.active {
            background: var(--primary-accent);
            color: white;
            border-color: var(--primary-accent);
        }

        /* Clickable Cards */
        .clickable-metric {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .clickable-metric:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        }

        .clickable-section {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .clickable-section:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }

        .clickable-row {
            cursor: pointer;
        }

        .clickable-row:hover {
            background: var(--primary-light) !important;
        }

        /* Mobile Detail Modal */
        @media (max-width: 768px) {
            .detail-modal-container {
                width: 100%;
                height: 100%;
                border-radius: 0;
            }

            .detail-modal-header {
                padding: 16px;
            }

            .detail-modal-body {
                padding: 16px;
            }

            .detail-summary-row {
                grid-template-columns: 1fr 1fr;
            }

            .detail-branch-header,
            .detail-branch-row {
                grid-template-columns: 2fr 1fr 1fr;
                font-size: 12px;
                padding: 12px 16px;
            }

            .detail-branch-header>*:nth-child(n+4),
            .detail-branch-row>*:nth-child(n+4) {
                display: none;
            }
        }

        /* ============================================
           ENHANCED MOBILE RESPONSIVE STYLES
           Mobile-First Approach Additions
           ============================================ */

        /* --- GLOBAL OVERFLOW PREVENTION --- */
        html {
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }

        html,
        body {
            max-width: 100vw;
            overscroll-behavior-x: none;
        }

        /* Prevent any element from causing horizontal scroll */
        .main-content,
        .dashboard-container,
        .modal-body,
        .detail-modal-body,
        .login-box,
        .form-section {
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Table scroll container for wide tables */
        .table-scroll-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .table-card {
            overflow-x: auto;
        }

        /* --- PERFORMANCE OPTIMIZATIONS --- */
        .sidebar,
        .modal-container,
        .detail-modal-container {
            will-change: transform;
        }

        /* Reduce motion for users who prefer it */
        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        /* --- iOS & MOBILE-SPECIFIC FIXES --- */
        @supports (-webkit-touch-callout: none) {

            /* iOS-specific styles */
            body {
                -webkit-text-size-adjust: 100%;
            }

            /* Prevent iOS zoom on input focus */
            input,
            select,
            textarea {
                font-size: 16px !important;
            }
        }

        /* Smooth scrolling for touch devices */
        .dashboard-container,
        .modal-body,
        .detail-modal-body,
        .search-results {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        /* --- EXTRA SMALL SCREENS (â‰¤ 480px) --- */
        @media (max-width: 480px) {
            :root {
                --sidebar-width: 85vw;
            }

            /* Base body adjustments */
            body {
                font-size: 14px;
            }

            /* Header */
            .top-header {
                height: 60px;
                padding: 0 12px;
                gap: 8px;
            }

            .hamburger-btn {
                display: flex !important;
                align-items: center;
                justify-content: center;
                width: 40px;
                height: 40px;
                min-width: 40px;
                padding: 8px;
                margin-right: 8px;
            }

            .breadcrumbs {
                font-size: 12px;
                flex: 1;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                max-width: 120px;
            }

            .header-actions {
                gap: 8px;
            }

            /* Hide search on very small screens */
            .search-container {
                display: none;
            }

            /* Date picker compact mode */
            .date-picker-wrapper {
                min-width: 0;
            }

            .date-picker {
                padding: 8px 10px;
                font-size: 12px;
                border-radius: 8px;
            }

            .date-picker .icon {
                width: 14px;
                height: 14px;
            }

            #headerDate {
                max-width: 80px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            /* Theme toggle compact */
            .theme-toggle {
                width: 36px;
                height: 36px;
                padding: 6px;
            }

            /* User profile - icon only */
            .user-profile {
                padding-left: 8px;
                border-left: none;
            }

            .avatar {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }

            .user-info {
                display: none !important;
            }

            /* Dashboard container */
            .dashboard-container {
                padding: 12px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            /* Metric cards */
            .metric-card {
                padding: 16px;
                gap: 8px;
                border-radius: 12px;
            }

            .metric-title {
                font-size: 12px;
            }

            .metric-value {
                font-size: 20px;
            }

            .metric-badge {
                font-size: 10px;
                padding: 3px 6px;
            }

            .metric-icon {
                width: 36px;
                height: 36px;
                border-radius: 10px;
            }

            /* Chart cards */
            .chart-card {
                padding: 16px;
                min-height: 250px;
                border-radius: 12px;
            }

            .chart-title {
                font-size: 14px;
            }

            /* Table cards */
            .table-card {
                padding: 12px;
                border-radius: 12px;
            }

            th {
                padding: 10px 8px;
                font-size: 10px;
            }

            td {
                padding: 10px 8px;
                font-size: 12px;
            }

            /* Date dropdown full width */
            .date-dropdown {
                position: fixed;
                top: 60px;
                left: 8px;
                right: 8px;
                width: auto;
                max-height: calc(100vh - 80px);
                overflow-y: auto;
                border-radius: 16px;
            }

            .date-quick-buttons {
                flex-wrap: wrap;
            }

            .date-quick-btn {
                flex: 1 1 30%;
                padding: 10px 6px;
                font-size: 10px;
            }

            .date-quick-btn .btn-icon {
                font-size: 16px;
            }

            .calendar-day {
                font-size: 11px;
            }

            /* Login overlay */
            .login-box {
                width: 100%;
                max-width: none;
                margin: 0 12px;
                padding: 24px 20px;
                border-radius: 20px;
            }

            .login-title {
                font-size: 20px;
            }

            .login-subtitle {
                font-size: 13px;
            }

            .btn {
                padding: 14px;
                font-size: 14px;
                min-height: 48px;
            }

            select {
                padding: 14px 12px;
                font-size: 16px;
                min-height: 48px;
            }

            /* Daily overlay */
            .overlay-time,
            #overlay-time {
                font-size: 48px !important;
            }

            .overlay-date,
            #overlay-date {
                font-size: 18px !important;
                margin-bottom: 40px !important;
            }

            .date-btn {
                min-width: 100%;
                max-width: 280px;
                padding: 16px 12px;
                border-radius: 12px;
            }

            .db-label {
                font-size: 12px;
            }

            .db-date {
                font-size: 14px;
            }

            .date-buttons-container {
                flex-direction: column !important;
                gap: 12px !important;
                align-items: center;
                width: 100%;
                max-width: 300px;
                margin: 0 auto;
            }

            .overlay-hint {
                font-size: 11px;
                margin-top: 20px;
            }

            /* Modals - full screen on mobile */
            .modal-container {
                width: 100%;
                height: 100%;
                max-height: 100%;
                border-radius: 0;
            }

            .modal-header {
                padding: 14px 16px;
                position: sticky;
                top: 0;
                z-index: 10;
            }

            .modal-title {
                font-size: 16px;
            }

            .modal-body {
                padding: 16px;
                flex: 1;
                overflow-y: auto;
            }

            .form-section {
                padding: 16px;
                margin-bottom: 16px;
                border-radius: 10px;
            }

            .form-section-title {
                font-size: 12px;
                margin-bottom: 14px;
            }

            .form-row {
                flex-direction: column;
                gap: 6px;
                margin-bottom: 12px;
            }

            .form-label {
                font-size: 12px;
                flex: none;
            }

            .form-input {
                padding: 12px;
                font-size: 16px;
                min-height: 44px;
                border-radius: 8px;
            }

            .grid-2-col {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .target-row {
                margin-bottom: 12px;
            }

            .target-header {
                font-size: 10px;
            }

            .modal-footer {
                padding: 14px 16px;
                position: sticky;
                bottom: 0;
                gap: 10px;
                flex-wrap: wrap;
            }

            .modal-footer button {
                flex: 1 1 100%;
                min-height: 44px;
                font-size: 13px;
            }

            /* Detail modal */
            .detail-modal-container {
                width: 100%;
                height: 100%;
                border-radius: 0;
            }

            .detail-modal-header {
                padding: 12px 16px;
                flex-wrap: wrap;
                gap: 8px;
            }

            .detail-modal-back {
                padding: 8px 12px;
                font-size: 12px;
            }

            .detail-modal-title {
                font-size: 16px;
                order: 2;
                width: 100%;
                margin-top: 8px;
            }

            .detail-modal-subtitle {
                font-size: 11px;
            }

            .detail-modal-close {
                width: 32px;
                height: 32px;
            }

            .detail-modal-body {
                padding: 12px;
            }

            .detail-summary-row {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .detail-stat-card {
                padding: 14px;
                border-radius: 12px;
            }

            .detail-stat-value {
                font-size: 22px;
            }

            .detail-stat-label {
                font-size: 10px;
            }

            .detail-filter-bar {
                gap: 8px;
                margin-bottom: 14px;
            }

            .detail-filter-btn {
                padding: 8px 12px;
                font-size: 11px;
            }

            .detail-branch-list {
                border-radius: 12px;
            }

            .detail-branch-header,
            .detail-branch-row {
                grid-template-columns: 1fr 1fr;
                padding: 10px 12px;
                font-size: 11px;
            }

            .detail-branch-header>*:nth-child(n+3),
            .detail-branch-row>*:nth-child(n+3) {
                display: none;
            }

            .detail-pct-badge {
                padding: 3px 8px;
                font-size: 10px;
            }

            /* Drill down grid */
            #drillDownGrid {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }

            /* Support card in sidebar */
            .support-card {
                padding: 16px;
                border-radius: 12px;
            }

            .support-title {
                font-size: 13px;
            }

            .support-text {
                font-size: 11px;
            }

            .btn-support {
                padding: 10px 16px;
                font-size: 12px;
            }

            /* Toast */
            #toast {
                left: 12px;
                right: 12px;
                transform: translateY(100px);
                padding: 12px 16px;
                font-size: 13px;
                border-radius: 12px;
            }

            #toast.visible {
                transform: translateY(0);
            }

            /* Loader */
            .loader-spinner {
                width: 40px;
                height: 40px;
            }

            .loader-text {
                font-size: 13px;
            }
        }

        /* --- SMALL SCREENS (481px - 640px) --- */
        @media (min-width: 481px) and (max-width: 640px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
                gap: 14px;
            }

            .dashboard-container {
                padding: 16px;
            }

            .grid-full {
                grid-column: span 2;
            }

            .grid-half {
                grid-column: span 2;
            }

            .metric-card {
                padding: 18px;
            }

            #drillDownGrid {
                grid-template-columns: 1fr 1fr !important;
            }

            .date-btn {
                min-width: 120px;
            }

            #overlay-time {
                font-size: 60px !important;
            }
        }

        /* --- MEDIUM SCREENS (641px - 768px) --- */
        @media (min-width: 641px) and (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 18px;
            }

            .grid-full {
                grid-column: span 2;
            }

            .modal-body {
                grid-template-columns: 1fr;
            }

            .grid-2-col {
                grid-template-columns: 1fr 1fr;
            }

            .detail-summary-row {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* --- ENHANCED TOUCH TARGETS (applies to all sizes) --- */
        @media (hover: none) and (pointer: coarse) {
            /* Touch device detection */

            .nav-item {
                padding: 14px 16px;
                min-height: 48px;
            }

            .btn,
            .btn-primary,
            .btn-outline,
            .btn-support,
            .date-btn,
            .date-quick-btn,
            .calendar-nav-btn,
            .detail-filter-btn,
            .date-apply-btn {
                min-height: 44px;
            }

            .form-input,
            select,
            input[type="date"],
            input[type="text"] {
                min-height: 44px;
                padding: 12px;
            }

            .modal-close,
            .detail-modal-close,
            .theme-toggle,
            .hamburger-btn {
                min-width: 44px;
                min-height: 44px;
            }

            /* Larger tap targets for calendar days */
            .calendar-day {
                min-height: 36px;
                min-width: 36px;
            }

            /* Better spacing for clickable items */
            .search-item {
                padding: 14px 16px;
            }

            .detail-branch-row {
                min-height: 56px;
            }

            /* Remove hover effects that don't work on touch */
            .metric-card:hover {
                transform: none;
            }

            .clickable-metric:hover {
                transform: none;
                box-shadow: var(--card-shadow);
            }

            /* Add active states instead */
            .metric-card:active,
            .clickable-metric:active {
                transform: scale(0.98);
                opacity: 0.9;
            }

            .btn:active,
            .nav-item:active,
            .date-btn:active {
                transform: scale(0.97);
            }
        }

        /* --- LANDSCAPE MOBILE --- */
        @media (max-height: 500px) and (orientation: landscape) {
            .top-header {
                height: 50px;
            }

            .dashboard-container {
                padding: 10px;
            }

            /* Login adjustments for landscape */
            .login-box {
                padding: 20px;
                max-height: 95vh;
                overflow-y: auto;
            }

            /* Daily overlay adjustments */
            #overlay-time {
                font-size: 40px !important;
            }

            #overlay-date {
                font-size: 16px !important;
                margin-bottom: 20px !important;
            }

            .date-btn {
                padding: 12px 16px;
            }
        }

        /* --- SAFE AREA INSETS (Notch devices) --- */
        @supports (padding-top: env(safe-area-inset-top)) {
            .top-header {
                padding-top: max(0px, env(safe-area-inset-top));
            }

            .sidebar {
                padding-top: max(24px, env(safe-area-inset-top));
                padding-bottom: max(24px, env(safe-area-inset-bottom));
            }

            .modal-footer {
                padding-bottom: max(20px, env(safe-area-inset-bottom));
            }

            .modal-container,
            .detail-modal-container {
                padding-bottom: env(safe-area-inset-bottom);
            }

            #toast {
                bottom: max(24px, calc(env(safe-area-inset-bottom) + 12px));
            }
        }

        /* --- PRINT STYLES --- */
        @media print {

            .sidebar,
            .hamburger-btn,
            .theme-toggle,
            .modal-overlay,
            .detail-modal-overlay,
            #login-overlay,
            #daily-overlay,
            #toast,
            .global-loader {
                display: none !important;
            }

            .main-content {
                width: 100% !important;
            }

            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>

    <!-- 1. SIDEBAR -->
    <nav class="sidebar" id="sidebar">
        <div class="brand">
            <img src="logo.png" alt="NLPL" style="height:32px; width:auto; border-radius:4px;">
            <span style="font-size:18px;">NLPL</span>
        </div>

        <div class="nav-menu">
            <a href="#" class="nav-item active" id="nav-dashboard" onclick="switchTab('dashboard')">
                <svg class="icon" viewBox="0 0 24 24">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                Dashboard
            </a>
            <a href="#" class="nav-item" id="nav-hierarchy" onclick="switchTab('hierarchy')">
                <svg class="icon" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                Detailed View
            </a>

            <a href="#" class="nav-item" id="nav-logout" onclick="handleLogout()">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Sign Out
            </a>
        </div>

        <div class="support-card">
            <div class="support-title">Need Help?</div>
            <div class="support-text">Check our documentation or contact support.</div>
            <button class="btn-support" onclick="window.open('https://wa.me/+918792320623', '_blank')">Get
                Support</button>
        </div>
    </nav>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- 2. MAIN CONTENT -->
    <main class="main-content">

        <!-- HEADER -->
        <header class="top-header">
            <button class="hamburger-btn" onclick="toggleSidebar()">
                <svg class="icon" viewBox="0 0 24 24">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <div class="breadcrumbs" id="breadcrumbs">
                Home / <span>Dashboard</span>
            </div>

            <div class="header-actions">
                <div class="search-container">
                    <svg class="icon search-icon" viewBox="0 0 24 24">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" class="search-input" placeholder="Jump to Branch..."
                        oninput="handleSearch(this.value)" onfocus="handleSearch(this.value)">
                    <div class="search-results" id="searchResults"></div>
                </div>

                <div class="date-picker-wrapper" style="position:relative;">
                    <div class="date-picker" id="ceoDatePicker" style="cursor:pointer;" onclick="toggleDateDropdown()">
                        <svg class="icon" viewBox="0 0 24 24" style="width:16px; height:16px;">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        <span id="headerDate">FY 2024-25</span>
                        <svg class="icon" viewBox="0 0 24 24"
                            style="width:12px; height:12px; margin-left:4px; opacity:0.6;" id="ceoCalendarIcon">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>

                    <!-- Date Range Dropdown -->
                    <div id="dateRangeDropdown" class="date-dropdown hidden">
                        <!-- Calendar Grid -->
                        <div class="calendar-container">
                            <div class="calendar-header">
                                <button class="calendar-nav-btn" onclick="navigateCalendar(-1)">â€¹</button>
                                <span id="calendarMonthYear">December 2025</span>
                                <button class="calendar-nav-btn" onclick="navigateCalendar(1)">â€º</button>
                            </div>
                            <div class="calendar-weekdays">
                                <span>Su</span><span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span>
                            </div>
                            <div class="calendar-days" id="calendarDays">
                                <!-- Days will be populated by JavaScript -->
                            </div>
                        </div>

                        <div class="date-range-divider">Quick Selection</div>

                        <!-- Quick Buttons -->
                        <div class="date-quick-buttons">
                            <button class="date-quick-btn" id="btn-today" onclick="selectDatePreset('today')">
                                <span class="btn-icon">ðŸ“…</span>
                                <span>Today</span>
                            </button>
                            <button class="date-quick-btn" id="btn-month" onclick="selectDatePreset('month')">
                                <span class="btn-icon">ðŸ“†</span>
                                <span>This Month</span>
                            </button>
                            <button class="date-quick-btn" id="btn-year" onclick="selectDatePreset('year')">
                                <span class="btn-icon">ðŸ“Š</span>
                                <span>This Year</span>
                            </button>
                        </div>

                        <div class="date-range-divider">Custom Range</div>

                        <!-- Date Range Inputs -->
                        <div class="date-range-inputs">
                            <div class="date-input-group">
                                <label>From</label>
                                <input type="date" id="dateFrom" onchange="validateDateRange()">
                            </div>
                            <div class="date-input-group">
                                <label>To</label>
                                <input type="date" id="dateTo" onchange="validateDateRange()">
                            </div>
                        </div>

                        <button class="date-apply-btn" id="dateApplyBtn" onclick="applyDateRange()">
                            Apply Range
                        </button>
                    </div>
                </div>

                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
                    <svg class="icon" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>

                <div class="user-profile">
                    <div class="avatar" id="headerAvatar">C</div>
                    <div class="user-info">
                        <span class="user-name" id="headerName">CEO User</span>
                        <span class="user-role" id="headerRole">Administrator</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- DASHBOARD CONTAINER -->
        <div class="dashboard-container" id="dashboard-container">
            <!-- Injected by JS -->
        </div>

    </main>

    <!-- 3. LOGIN OVERLAY -->
    <div id="login-overlay">
        <div class="login-box">
            <div class="brand" style="justify-content:center; margin-bottom:20px;">
                <img src="logo.png" alt="NLPL" style="height:40px; width:auto;">
            </div>

            <h1 class="login-title">Welcome Back</h1>
            <p class="login-subtitle">Enter your credentials to access the portal.</p>

            <div style="text-align:left; margin-bottom: 24px;">
                <button class="btn btn-primary" onclick="handleLogin('CEO')" style="margin-bottom: 16px;">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    Login as Headquarters (CEO)
                </button>

                <div style="display:flex; align-items:center; gap:10px; margin: 16px 0;">
                    <div style="height:1px; background:var(--border-color); flex:1;"></div>
                    <span style="font-size:12px; color:var(--text-secondary);">OR REGIONAL ACCESS</span>
                    <div style="height:1px; background:var(--border-color); flex:1;"></div>
                </div>

                <select id="dmSelect">
                    <option value="" disabled selected>Select Manager Name...</option>
                    <!-- Injected Options -->
                </select>

                <button class="btn btn-outline" onclick="handleLogin('DM')">
                    Login as District Manager
                </button>
            </div>
        </div>
    </div>

    <!-- DAILY OVERLAY (DATE SELECTION) -->
    <div id="daily-overlay" class="hidden">
        <div class="overlay-content" style="text-align:center; padding: 20px;">
            <!-- Time at Top -->
            <div id="overlay-time" class="overlay-time">00:00:00</div>

            <!-- Date in Center -->
            <div id="overlay-date" class="overlay-date"></div>

            <!-- 3 Buttons -->
            <div class="date-buttons-container">
                <button class="date-btn" onclick="selectSystemDate(0)">
                    <div class="db-label">Today</div>
                    <div class="db-date" id="btn-date-0">...</div>
                </button>
                <button class="date-btn" onclick="selectSystemDate(1)">
                    <div class="db-label">Tomorrow</div>
                    <div class="db-date" id="btn-date-1">...</div>
                </button>
                <button class="date-btn" onclick="selectSystemDate(2)">
                    <div class="db-label">Day After</div>
                    <div class="db-date" id="btn-date-2">...</div>
                </button>
            </div>
            <div class="overlay-hint">Select date to proceed</div>
        </div>
    </div>

    <!-- TOAST ELEMENT -->
    <div id="toast">
        <svg class="icon" viewBox="0 0 24 24">
            <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        <span id="toastMsg">Action Successful</span>
    </div>

    <!-- GLOBAL LOADER -->
    <div class="global-loader" id="global-loader">
        <div class="loader-spinner"></div>
        <div class="loader-text">Loading...</div>
    </div>
    <!-- BRANCH DETAILS MODAL -->
    <div class="modal-overlay" id="branchModal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title" id="modalBranchTitle">Branch Details</div>
                <button class="modal-close" onclick="closeBranchModal()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- LEFT COLUMN -->
                <div class="left-panel">

                    <!-- Row 1 -->
                    <div class="grid-2-col">
                        <div class="form-section">
                            <div class="form-section-title">FTOD - ACCOUNTS</div>
                            <div class="form-row">
                                <label class="form-label">Actual FTOD Account</label>
                                <input class="form-input" id="ftod_actual" placeholder="Actual FTOD Account">
                            </div>
                            <div class="form-row">
                                <label class="form-label">FTOD Collection Plan</label>
                                <input class="form-input" id="ftod_plan" placeholder="FTOD Collection Plan">
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">NOV-25 SLIPPED ACCOUNT</div>
                            <div class="form-row">
                                <label class="form-label">Actual Account</label>
                                <input class="form-input" id="lived_actual" placeholder="Actual Account">
                            </div>
                            <div class="form-row">
                                <label class="form-label">Collection Plan</label>
                                <input class="form-input" id="lived_plan" placeholder="Collection Plan">
                            </div>
                        </div>
                    </div>

                    <!-- Row 2 -->
                    <div class="grid-2-col">
                        <div class="form-section">
                            <div class="form-section-title">PNPA ACCOUNTS</div>
                            <div class="form-row">
                                <label class="form-label">Actual PNPA Account</label>
                                <input class="form-input" id="pnpa_actual" placeholder="Actual PNPA Account">
                            </div>
                            <div class="form-row">
                                <label class="form-label">PNPA Collection Plan</label>
                                <input class="form-input" id="pnpa_plan" placeholder="PNPA Collection Plan">
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">NPA ACCOUNTS</div>
                            <div class="form-row">
                                <label class="form-label">NPA ACTIVATION</label>
                                <input class="form-input" id="npa_activation" placeholder="NPA ACTIVATION">
                            </div>
                            <div class="form-row">
                                <label class="form-label">NPA CLOSURE</label>
                                <input class="form-input" id="npa_closure" placeholder="NPA CLOSURE">
                            </div>
                        </div>
                    </div>

                    <!-- Row 3 -->
                    <div class="form-section">
                        <div class="form-section-title">FY 25-26 Accounts</div>
                        <div class="grid-2-col">
                            <div>
                                <div class="form-row">
                                    <label class="form-label">TOTAL OD ACCOUNTS</label>
                                    <input class="form-input" id="fy_od_acc" placeholder="TOTAL OD ACCOUNTS">
                                </div>
                                <div class="form-row">
                                    <label class="form-label">COLLECTION PLAN</label>
                                    <input class="form-input" id="fy_od_plan" placeholder="COLLECTION PLAN">
                                </div>
                            </div>
                            <div>
                                <div class="form-row">
                                    <label class="form-label">NON-STARTER ACCOUNTS</label>
                                    <input class="form-input" id="fy_non_start_acc" placeholder="NON-STARTER ACCOUNTS">
                                </div>
                                <div class="form-row">
                                    <label class="form-label">COLLECTION PLAN</label>
                                    <input class="form-input" id="fy_non_start_plan" placeholder="COLLECTION PLAN">
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- RIGHT COLUMN -->
                <div class="right-panel">

                    <div class="form-section">
                        <div class="form-section-title"
                            style="text-align:left; display:flex; align-items:center; gap:8px;">
                            <input type="checkbox" checked disabled> Disbursement Targets
                        </div>

                        <div class="target-row">
                            <div class="target-header">
                                <span>Sanction Pending (Accounts)</span>
                                <span>Target: 0</span>
                            </div>
                            <input class="form-input" id="disb_sanc_pent_acc" placeholder="Enter achievement...">
                        </div>

                        <div class="target-row">
                            <div class="target-header">
                                <span>Sanction Pending (Amount)</span>
                                <span>Target: 0</span>
                            </div>
                            <input class="form-input" id="disb_sanc_pent_amt" placeholder="Enter achievement...">
                        </div>

                        <div class="target-row">
                            <div class="target-header">
                                <span>IGL & FIG (Accounts)</span>
                                <span>Target: 0</span>
                            </div>
                            <input class="form-input" id="disb_igl_acc" placeholder="Enter achievement...">
                        </div>

                        <div class="target-row">
                            <div class="target-header">
                                <span>IGL & FIG (Amount)</span>
                                <span>Target: 0</span>
                            </div>
                            <input class="form-input" id="disb_igl_amt" placeholder="Enter achievement...">
                        </div>

                        <div class="target-row">
                            <div class="target-header">
                                <span>IL (Accounts)</span>
                                <span>Target: 0</span>
                            </div>
                            <input class="form-input" id="disb_il_acc" placeholder="Enter achievement...">
                        </div>

                        <div class="target-row">
                            <div class="target-header">
                                <span>IL (Amount)</span>
                                <span>Target: 0</span>
                            </div>
                            <input class="form-input" id="disb_il_amt" placeholder="Enter achievement...">
                        </div>

                    </div>

                    <div class="form-section">
                        <div class="form-section-title">KYC SOURCING</div>

                        <div class="form-row">
                            <label class="form-label">FIG AND IGL</label>
                            <input class="form-input" id="kyc_fig_igl" placeholder="TOTAL OD ACCOUNTS">
                        </div>

                        <div class="form-row">
                            <label class="form-label">IL</label>
                            <input class="form-input" id="kyc_il" placeholder="COLLECTION PLAN">
                        </div>

                        <div class="form-row">
                            <label class="form-label">NPA</label>
                            <input class="form-input" id="kyc_npa" placeholder="COLLECTION PLAN">
                        </div>
                    </div>

                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" style="width:auto;" onclick="closeBranchModal()">Cancel</button>
                <button class="btn btn-primary" style="width:auto; background: #4B5563;"
                    onclick="saveBranchDetails(false)">Save & Close</button>
                <button class="btn btn-primary" style="width:auto;" onclick="saveBranchDetails(true)">Save & Next Branch
                    â†’</button>
            </div>
        </div>
    </div>


    <!-- CEO DETAIL ANALYSIS MODAL -->
    <div class="detail-modal-overlay" id="detailModal">
        <div class="detail-modal-container">
            <div class="detail-modal-header">
                <button class="detail-modal-back" onclick="closeDetailModal()">
                    <svg class="icon" style="width:16px;height:16px;" viewBox="0 0 24 24">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                    Back to Dashboard
                </button>
                <div class="detail-modal-title" id="detailModalTitle">
                    <span id="detailTitleIcon">ðŸ“Š</span>
                    <span id="detailTitleText">Detailed Analysis</span>
                    <span class="detail-modal-subtitle" id="detailSubtitle"></span>
                </div>
                <button class="detail-modal-close" onclick="closeDetailModal()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="detail-modal-body" id="detailModalBody">
                <!-- Dynamic content injected here -->
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // --- SUPABASE CONFIG ---
        const SUPABASE_URL = 'https://zovnmmdfthpbubrorsgh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpvdm5tbWRmdGhwYnVicm9yc2doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NzE3ODgsImV4cCI6MjA3NzE0Nzc4OH0.92BH2sjUOgkw6iSRj1_4gt0p3eThg3QT4VK-Q4EdmBE';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- DATA & STATE ---
        const defaultTSVData = `Branch	District	DM name	Region	
KADIRI	KADAPA	PUTTA PRASAD	ANDRA PRADESH	
DHARMAVARAM	KADAPA	PUTTA PRASAD	ANDRA PRADESH	
BUDWAL	KADAPA	PUTTA PRASAD	ANDRA PRADESH	
KADAPA	KADAPA	PUTTA PRASAD	ANDRA PRADESH	
KUDLIGI	KUDLIGI	A B MANJUNATHA	DHARWAD 	
KHANAHOSAHALLI	KUDLIGI	A B MANJUNATHA	DHARWAD 	
HARAPANAHALLI	KUDLIGI	A B MANJUNATHA	DHARWAD 	
KOTTURU	KUDLIGI	A B MANJUNATHA	DHARWAD 	
 SANDURU 	BALLARI	BAIRAPPA	DHARWAD 	
SIRUGUPPA	BALLARI	BAIRAPPA	DHARWAD 	
BALLARI	BALLARI	BAIRAPPA	DHARWAD 	
KUDATHINI	BALLARI	BAIRAPPA	DHARWAD 	
NARAGUNDA	BADAMI	BASAVARAJAPPA	DHARWAD 	
BADAMI	BADAMI	BASAVARAJAPPA	DHARWAD 	
GAJENDRAGAD	BADAMI	BASAVARAJAPPA	DHARWAD 	
RAMDURGA	BADAMI	BASAVARAJAPPA	DHARWAD 	
GADAG	GADAG	CHANDRAGOUD PATIL	DHARWAD 	
LAXMESHWAR	GADAG	CHANDRAGOUD PATIL	DHARWAD 	
MUNDARAGI	GADAG	CHANDRAGOUD PATIL	DHARWAD 	
HARIHARA	DAVANAGERE	DAMODHARA	DHARWAD 	
SANTHEBENNURU	DAVANAGERE	DAMODHARA	DHARWAD 	
HONNALI	DAVANAGERE	DAMODHARA	DHARWAD 	
DAVANAGERE	DAVANAGERE	DAMODHARA	DHARWAD 	
DHARWAD	DHARWAD	GANAPATI FAKKIRAPPA BAVUKAR	DHARWAD 	
KALGHATGI	DHARWAD	GANAPATI FAKKIRAPPA BAVUKAR	DHARWAD 	
HUBLI-2	DHARWAD	GANAPATI FAKKIRAPPA BAVUKAR	DHARWAD 	
HUBLI	DHARWAD	GANAPATI FAKKIRAPPA BAVUKAR	DHARWAD 	
GOKAK	BELAGAVI	HAJIALI TIGADI	DHARWAD 	
KITTUR	BELAGAVI	HAJIALI TIGADI	DHARWAD 	
BAILHONGAL	BELAGAVI	HAJIALI TIGADI	DHARWAD 	
BELAGAVI	BELAGAVI	HAJIALI TIGADI	DHARWAD 	
YARAGATTI	BELAGAVI	HAJIALI TIGADI	DHARWAD 	
HAGARIBOMMANAHALLI	VIJAYANAGARA	PAVANKUMAR SHERKHANE	DHARWAD 	
HUVENAHADAGALLI	VIJAYANAGARA	PAVANKUMAR SHERKHANE	DHARWAD 	
HOSPET	VIJAYANAGARA	PAVANKUMAR SHERKHANE	DHARWAD 	
CHIKKODI	CHIKKODI	SUNIL KUBER MALAGE	DHARWAD 	
NIPPANI	CHIKKODI	SUNIL KUBER MALAGE	DHARWAD 	
MUDALAGI	CHIKKODI	SUNIL KUBER MALAGE	DHARWAD 	
ATHANI	CHIKKODI	SUNIL KUBER MALAGE	DHARWAD 	
LOKAPUR	BAGALKOTE	DODDAADIVEPPA BASETEPPA NAVALGUND	KALBURGI 	
JAMAKHANDI	BAGALKOTE	DODDAADIVEPPA BASETEPPA NAVALGUND	KALBURGI 	
BILAGI	BAGALKOTE	DODDAADIVEPPA BASETEPPA NAVALGUND	KALBURGI 	
BAGALKOT	BAGALKOTE	DODDAADIVEPPA BASETEPPA NAVALGUND	KALBURGI 	
TALIKOTI	VIJAYAPURA	GOVIND BADIGER	KALBURGI 	
SINDAGI	VIJAYAPURA	GOVIND BADIGER	KALBURGI 	
MUDDEBIHAL	VIJAYAPURA	GOVIND BADIGER	KALBURGI 	
TIKOTA	VIJAYAPURA	GOVIND BADIGER	KALBURGI 	
VIJAYAPUR	VIJAYAPURA	GOVIND BADIGER	KALBURGI 	
HUMNABAD	HUMNABAD	MALLIKARJUN WAGHRAJ	KALBURGI 	
KAMALAPURA	HUMNABAD	MALLIKARJUN WAGHRAJ	KALBURGI 	
HULSOOR	HUMNABAD	MALLIKARJUN WAGHRAJ	KALBURGI 	
BASAVAKALYAN	HUMNABAD	MALLIKARJUN WAGHRAJ	KALBURGI 	
BHALKI	BIDAR	MANOHAR	KALBURGI 	
AURAD	BIDAR	MANOHAR	KALBURGI 	
BIDAR-2	BIDAR	MANOHAR	KALBURGI 	
BIDAR	BIDAR	MANOHAR	KALBURGI 	
SIRWAR	LINGSUGUR	PANDARIGONDA	KALBURGI 	
LINGSUGUR	LINGSUGUR	PANDARIGONDA	KALBURGI 	
MANVI	LINGSUGUR	PANDARIGONDA	KALBURGI 	
RAICHUR	LINGSUGUR	PANDARIGONDA	KALBURGI 	
SINDHNUR	LINGSUGUR	PANDARIGONDA	KALBURGI 	
SEDAM	SEDAM	PHILIP	KALBURGI 	
CHINCHOLI	SEDAM	PHILIP	KALBURGI 	
YADGIR	SEDAM	PHILIP	KALBURGI 	
KALAGI	SEDAM	PHILIP	KALBURGI 	
JEVARGI	KALBURGI	PRASHANTH	KALBURGI 	
KALABURAGI	KALBURGI	PRASHANTH	KALBURGI 	
ALAND	KALBURGI	PRASHANTH	KALBURGI 	
KALBURGI-2	KALBURGI	PRASHANTH	KALBURGI 	
CHADCHAN	INDI	RAJKUMAR PAWAR	KALBURGI 	
ALMEL	INDI	RAJKUMAR PAWAR	KALBURGI 	
AFZALPUR	INDI	RAJKUMAR PAWAR	KALBURGI 	
INDI	INDI	RAJKUMAR PAWAR	KALBURGI 	
DEVADURGA	SHAHAPUR	VEERESH	KALBURGI 	
SHAHAPUR	SHAHAPUR	VEERESH	KALBURGI 	
KOPPAL	KUSHTAGI	VIRUPAKSHAPPA CHOUDI	KALBURGI 	
HUNGUND	KUSHTAGI	VIRUPAKSHAPPA CHOUDI	KALBURGI 	
GANGAVATHI	KUSHTAGI	VIRUPAKSHAPPA CHOUDI	KALBURGI 	
KUSHTAGI	KUSHTAGI	VIRUPAKSHAPPA CHOUDI	KALBURGI 	
TANDUR	MAHABOOBNAGAR	MADHU	TELANGANA	
MARIKAL	MAHABOOBNAGAR	MADHU	TELANGANA	
MAHABUB NAGAR	MAHABOOBNAGAR	MADHU	TELANGANA	
GADWAL	MAHABOOBNAGAR	MADHU	TELANGANA	
KODANGAL	SANGAREDDY	SAMPATH KUMAR	TELANGANA	
NARAYANKHED	SANGAREDDY	SAMPATH KUMAR	TELANGANA	
SANGAREDDY	SANGAREDDY	SAMPATH KUMAR	TELANGANA	
ZAHEERABAD	SANGAREDDY	SAMPATH KUMAR	TELANGANA	
NR PURA	CHIKKAMAGALURU	AJITH KUMAR S A	TUMKUR	
MUDIGERE	CHIKKAMAGALURU	AJITH KUMAR S A	TUMKUR	
CHIKKAMAGALURU	CHIKKAMAGALURU	AJITH KUMAR S A	TUMKUR	
PANCHANHALLI	KADUR	ARUN KUMAR K H	TUMKUR	
TARIKERE	KADUR	ARUN KUMAR K H	TUMKUR	
AJJAMPURA	KADUR	ARUN KUMAR K H	TUMKUR	
KADUR	KADUR	ARUN KUMAR K H	TUMKUR	
SIRA	TUMKUR	DINESH D	TUMKUR	
KUNIGAL	TUMKUR	DINESH D	TUMKUR	
MADHUGIRI	TUMKUR	DINESH D	TUMKUR	
TUMKUR	TUMKUR	DINESH D	TUMKUR	
KORATAGERE	TUMKUR	DINESH D	TUMKUR	
HOLAKERE	HOLALKERE	KUMAR R	TUMKUR	
CHANNAGIRI	HOLALKERE	KUMAR R	TUMKUR	
HOSADURGA	HOLALKERE	KUMAR R	TUMKUR	
JAGALORE	CHITRADURGA	MANOJ NAIK B	TUMKUR	
CHITRADURGA	CHITRADURGA	MANOJ NAIK B	TUMKUR	
CHALLAKERE	CHITRADURGA	MANOJ NAIK B	TUMKUR	
HIRIYUR	CHITRADURGA	MANOJ NAIK B	TUMKUR	
J P NAGAR	BENGALORE -URBAN	MUBARAK S	TUMKUR	
HEBBAL	BENGALORE -URBAN	MUBARAK S	TUMKUR	
CHANDAPURA	BENGALORE -URBAN	MUBARAK S	TUMKUR	
KENGERI	BENGALORE -URBAN	MUBARAK S	TUMKUR	
CHINTAMANI	CHIKKABALLAPUR	MUNIRAJU P V	TUMKUR	
SRINIVASPURA	CHIKKABALLAPUR	MUNIRAJU P V	TUMKUR	
DEVANAHALLI	CHIKKABALLAPUR	MUNIRAJU P V	TUMKUR	
CHIKBALLAPURA	CHIKKABALLAPUR	MUNIRAJU P V	TUMKUR	
BAGEPALLI	CHIKKABALLAPUR	MUNIRAJU P V	TUMKUR	
CHIKKANAYAKANAHALLI	TIPTUR	P T VENKATESH	TUMKUR	
HULIYAR	TIPTUR	P T VENKATESH	TUMKUR	
GUBBI	TIPTUR	P T VENKATESH	TUMKUR	
TIPTUR	TIPTUR	P T VENKATESH	TUMKUR	
TUREVEKERE	TIPTUR	P T VENKATESH	TUMKUR	
BETHAMANGALA	KOLAR	SHIVARAJA N	TUMKUR	
KOLAR	KOLAR	SHIVARAJA N	TUMKUR	
BANGARPET	KOLAR	SHIVARAJA N	TUMKUR	
MALUR	KOLAR	SHIVARAJA N	TUMKUR	
DODDABALLAPURA	BENGALORE -RURAL 	VINAY V L	TUMKUR	
DABUSPET	BENGALORE -RURAL 	VINAY V L	TUMKUR	
GOWRIBIDANUR	BENGALORE -RURAL 	VINAY V L	TUMKUR	`;

        let state = {
            currentUser: null,
            role: null,
            rawData: null,
            targetData: {},
            branchDetails: {}, // Main Store
            activeTab: 'dashboard',
            viewStack: [],
            fullTree: {},
            systemDate: new Date().toISOString().split('T')[0], // Default to Today
            isLoading: false, // Track loading state
            realtimeChannels: [] // Track subscriptions for cleanup
        };

        // --- PERFORMANCE UTILITIES ---
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function throttle(func, limit) {
            let inThrottle;
            return function (...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        // --- LOADING STATE MANAGEMENT ---
        function setLoading(isLoading, message = 'Loading...') {
            state.isLoading = isLoading;
            const loader = document.getElementById('global-loader');
            if (loader) {
                if (isLoading) {
                    loader.querySelector('.loader-text').textContent = message;
                    loader.classList.add('visible');
                } else {
                    loader.classList.remove('visible');
                }
            }
        }

        // --- ERROR BOUNDARY ---
        function safeExecute(fn, fallback = null, context = 'Operation') {
            try {
                const result = fn();
                if (result instanceof Promise) {
                    return result.catch(err => {
                        console.error(`${context} Error:`, err);
                        showToast(`${context} failed. Please try again.`, 'alert');
                        return fallback;
                    });
                }
                return result;
            } catch (err) {
                console.error(`${context} Error:`, err);
                showToast(`${context} failed. Please try again.`, 'alert');
                return fallback;
            }
        }

        // --- INIT ---
        window.addEventListener("DOMContentLoaded", async () => {
            const { headers, rows } = parseTSV(defaultTSVData);
            state.rawData = { headers, rows };
            state.fullTree = buildHierarchy(headers, rows);

            // Populate DM Dropdown
            populateDMDropdown(rows, headers);

            // Load Local Targets (Keep local for now as per requirement focus on Branch Details)
            const saved = localStorage.getItem('dosa_targets');
            if (saved) state.targetData = JSON.parse(saved);

            // Init Header Date (Will be updated on selection)
            updateHeaderDate(state.systemDate);

            // Note: We DO NOT fetch data automatically here anymore.
            // We wait for Date Selection in the Overlay.

            // Hide Sidebar/Content initially
            document.getElementById("sidebar").classList.add("hidden");
            document.querySelector(".main-content").classList.add("hidden");
        });

        function updateHeaderDate(isoDate) {
            const dateObj = new Date(isoDate);
            const dateStr = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            document.getElementById("headerDate").textContent = dateStr;

            // Also update the hidden date input for CEO calendar picker
            const dateInput = document.getElementById("ceoDateInput");
            if (dateInput) {
                dateInput.value = isoDate;
            }
        }

        // CEO Calendar Functions
        let calendarDate = new Date(); // Current calendar view month

        function toggleDateDropdown() {
            // Only allow CEO to use calendar
            if (state.role !== 'CEO') return;

            const dropdown = document.getElementById('dateRangeDropdown');
            const wasHidden = dropdown.classList.contains('hidden');
            dropdown.classList.toggle('hidden');

            // If opening, render calendar
            if (wasHidden) {
                calendarDate = new Date(); // Reset to current month
                renderCalendar();
            }

            // Set default dates if not set
            const dateFrom = document.getElementById('dateFrom');
            const dateTo = document.getElementById('dateTo');
            if (!dateFrom.value) {
                dateFrom.value = state.systemDate;
                dateTo.value = state.systemDate;
            }
        }

        function navigateCalendar(direction) {
            calendarDate.setMonth(calendarDate.getMonth() + direction);
            renderCalendar();
        }

        function renderCalendar() {
            const container = document.getElementById('calendarDays');
            const monthYearLabel = document.getElementById('calendarMonthYear');

            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();

            // Update month/year label
            monthYearLabel.textContent = calendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            // Today's date for comparison
            const today = new Date();
            const todayStr = formatDateISO(today);

            let html = '';

            // Previous month's days
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const dateStr = formatDateISO(new Date(year, month - 1, day));
                html += `<div class="calendar-day other-month" onclick="selectCalendarDate('${dateStr}')">${day}</div>`;
            }

            // Current month's days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = formatDateISO(new Date(year, month, day));
                let classes = 'calendar-day';

                if (dateStr === todayStr) {
                    classes += ' today';
                }
                if (dateStr === state.systemDate) {
                    classes += ' selected';
                }

                html += `<div class="${classes}" onclick="selectCalendarDate('${dateStr}')">${day}</div>`;
            }

            // Next month's days (fill remaining cells)
            const totalCells = 42; // 6 rows x 7 columns
            const currentCells = firstDay + daysInMonth;
            for (let i = 1; i <= totalCells - currentCells; i++) {
                const dateStr = formatDateISO(new Date(year, month + 1, i));
                html += `<div class="calendar-day other-month" onclick="selectCalendarDate('${dateStr}')">${i}</div>`;
            }

            container.innerHTML = html;
        }

        function selectCalendarDate(dateStr) {
            // Clear quick button selection
            document.querySelectorAll('.date-quick-btn').forEach(btn => btn.classList.remove('active'));

            // Format label
            const dateObj = new Date(dateStr);
            const label = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

            // Apply single date
            applyDateRangeInternal(dateStr, dateStr, label);
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (e) {
            const wrapper = document.querySelector('.date-picker-wrapper');
            const dropdown = document.getElementById('dateRangeDropdown');
            if (wrapper && dropdown && !wrapper.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });

        function selectDatePreset(preset) {
            const now = new Date();
            let fromDate, toDate, label;

            // Remove active state from all buttons
            document.querySelectorAll('.date-quick-btn').forEach(btn => btn.classList.remove('active'));

            switch (preset) {
                case 'today':
                    fromDate = toDate = formatDateISO(now);
                    label = new Date(fromDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    document.getElementById('btn-today').classList.add('active');
                    break;
                case 'month':
                    fromDate = formatDateISO(new Date(now.getFullYear(), now.getMonth(), 1));
                    toDate = formatDateISO(now);
                    label = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    document.getElementById('btn-month').classList.add('active');
                    break;
                case 'year':
                    fromDate = formatDateISO(new Date(now.getFullYear(), 0, 1));
                    toDate = formatDateISO(now);
                    label = `Year ${now.getFullYear()}`;
                    document.getElementById('btn-year').classList.add('active');
                    break;
            }

            // Apply the date range
            applyDateRangeInternal(fromDate, toDate, label);
        }

        function formatDateISO(date) {
            const offset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() - offset).toISOString().split('T')[0];
        }

        function validateDateRange() {
            const from = document.getElementById('dateFrom').value;
            const to = document.getElementById('dateTo').value;
            const btn = document.getElementById('dateApplyBtn');

            if (from && to && from <= to) {
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }

        function applyDateRange() {
            const from = document.getElementById('dateFrom').value;
            const to = document.getElementById('dateTo').value;

            if (!from || !to || from > to) {
                showToast('âš ï¸ Please select a valid date range', true);
                return;
            }

            // Format label
            const fromDate = new Date(from);
            const toDate = new Date(to);
            let label;

            if (from === to) {
                label = fromDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            } else {
                label = `${fromDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${toDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
            }

            applyDateRangeInternal(from, to, label);
        }

        async function applyDateRangeInternal(fromDate, toDate, label) {
            // Close dropdown
            document.getElementById('dateRangeDropdown').classList.add('hidden');

            // Store date range in state
            state.dateFrom = fromDate;
            state.dateTo = toDate;
            state.systemDate = toDate; // For compatibility

            // Update header
            document.getElementById('headerDate').textContent = label;

            // Show loading
            setLoading(true, `Loading data for ${label}...`);

            try {
                // Fetch data for date range
                await fetchSupabaseDataRange(fromDate, toDate);

                // Re-render dashboard
                renderDashboard();

                // Show toast
                if (fromDate === toDate) {
                    showToast(`ðŸ“… Viewing data for ${label}`);
                } else {
                    showToast(`ðŸ“… Viewing aggregated data: ${label}`);
                }
            } catch (error) {
                console.error('Error fetching date range:', error);
                showToast('âš ï¸ Error loading date range data', true);
            }
        }

        // Fetch data for a date range (aggregates multiple days)
        async function fetchSupabaseDataRange(fromDate, toDate) {
            console.log(`Fetching data from ${fromDate} to ${toDate}`);

            try {
                const p1 = supabase.from('daily_reports').select('*').gte('date', fromDate).lte('date', toDate);
                const p2 = supabase.from('daily_reports_achievements').select('*').gte('date', fromDate).lte('date', toDate);

                const [resTarget, resAchieve] = await Promise.all([p1, p2]);

                if (resTarget.error || resAchieve.error) {
                    throw new Error(resTarget.error?.message || resAchieve.error?.message);
                }

                // Aggregate data by branch (sum numeric, keep latest for branch details)
                const aggregatedTargets = aggregateDataByBranch(resTarget.data || []);
                const aggregatedAchievements = aggregateDataByBranch(resAchieve.data || []);

                state.rawData = aggregatedTargets;
                state.achievementData = aggregatedAchievements;

                // Build branch details (target + achieve)
                const branchDetails = {};
                aggregatedTargets.forEach(row => {
                    const br = row.branch_name;
                    if (!branchDetails[br]) branchDetails[br] = {};
                    branchDetails[br].target = row;
                });
                aggregatedAchievements.forEach(row => {
                    const br = row.branch_name;
                    if (!branchDetails[br]) branchDetails[br] = {};
                    branchDetails[br].achieve = row;
                });
                state.branchDetails = branchDetails;

                console.log(`Loaded ${Object.keys(branchDetails).length} branches for date range`);
                setLoading(false);

            } catch (error) {
                console.error('Fetch range error:', error);
                setLoading(false);
                throw error;
            }
        }

        // Helper to aggregate data by branch (sum numeric fields)
        function aggregateDataByBranch(rows) {
            const byBranch = {};

            rows.forEach(row => {
                const branchName = row.branch_name;
                if (!byBranch[branchName]) {
                    byBranch[branchName] = { ...row };
                } else {
                    // Sum numeric fields
                    Object.keys(row).forEach(key => {
                        if (typeof row[key] === 'number' && key !== 'id') {
                            byBranch[branchName][key] = (byBranch[branchName][key] || 0) + row[key];
                        }
                    });
                    // Keep non-numeric fields from latest date
                    if (row.date > byBranch[branchName].date) {
                        byBranch[branchName].date = row.date;
                        byBranch[branchName].dm_name = row.dm_name;
                        byBranch[branchName].region = row.region;
                        byBranch[branchName].district = row.district;
                    }
                }
            });

            return Object.values(byBranch);
        }

        // --- SUPABASE ACTIONS ---
        async function fetchSupabaseData() {
            const targetDate = state.systemDate;
            console.log("Fetching data for:", targetDate);

            setLoading(true, 'Loading data...');

            try {
                // Parallel Fetch with timeout for reliability
                const timeout = new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Request timeout')), 15000)
                );

                const p1 = supabase.from('daily_reports').select('*').eq('date', targetDate);
                const p2 = supabase.from('daily_reports_achievements').select('*').eq('date', targetDate);

                const [resTarget, resAchieve] = await Promise.race([
                    Promise.all([p1, p2]),
                    timeout
                ]);

                if (resTarget.error || resAchieve.error) {
                    const errorMsg = resTarget.error?.message || resAchieve.error?.message || 'Unknown error';
                    console.error("Supabase Load Error:", errorMsg);
                    showToast('Failed to load data: ' + errorMsg, 'alert');
                    return;
                }

                // MERGE Logic
                state.branchDetails = {};

                // Map Targets
                (resTarget.data || []).forEach(row => {
                    if (!state.branchDetails[row.branch_name]) state.branchDetails[row.branch_name] = {};
                    state.branchDetails[row.branch_name].target = row;
                });

                // Map Achievements
                (resAchieve.data || []).forEach(row => {
                    if (!state.branchDetails[row.branch_name]) state.branchDetails[row.branch_name] = {};
                    state.branchDetails[row.branch_name].achievement = row;
                });

                const targetCount = resTarget.data?.length || 0;
                const achieveCount = resAchieve.data?.length || 0;
                console.log('Loaded ' + targetCount + ' targets and ' + achieveCount + ' achievements for ' + targetDate);

                renderDashboard();
            } catch (err) {
                console.error("Fetch Error:", err);
                showToast('Connection error. Please check your network.', 'alert');
            } finally {
                setLoading(false);
            }
        }

        // --- REALTIME SUBSCRIPTION ---
        // Throttled render to prevent UI thrashing during rapid updates
        const throttledRender = throttle(() => {
            if (state.activeTab === 'hierarchy') {
                renderDashboard();
            }
        }, 500);

        function cleanupRealtimeSubscriptions() {
            // Unsubscribe from all existing channels
            state.realtimeChannels.forEach(channel => {
                try {
                    supabase.removeChannel(channel);
                } catch (err) {
                    console.warn('Channel cleanup warning:', err);
                }
            });
            state.realtimeChannels = [];
        }

        function setupRealtime() {
            // Clean up existing subscriptions first
            cleanupRealtimeSubscriptions();

            const dateFilter = state.systemDate;

            // Channel for Targets
            const targetChannel = supabase
                .channel('public:daily_reports')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'daily_reports' }, payload => {
                    const newData = payload.new;
                    if (newData && newData.date === state.systemDate) {
                        // Merge into existing state
                        if (!state.branchDetails[newData.branch_name]) state.branchDetails[newData.branch_name] = {};
                        state.branchDetails[newData.branch_name].target = newData;
                        throttledRender();
                    }
                })
                .subscribe((status) => {
                    if (status === 'CHANNEL_ERROR') {
                        console.error('Realtime subscription error for daily_reports');
                    }
                });

            state.realtimeChannels.push(targetChannel);

            // Channel for Achievements
            const achievementChannel = supabase
                .channel('public:daily_reports_achievements')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'daily_reports_achievements' }, payload => {
                    const newData = payload.new;
                    if (newData && newData.date === state.systemDate) {
                        // Merge into existing state
                        if (!state.branchDetails[newData.branch_name]) state.branchDetails[newData.branch_name] = {};
                        state.branchDetails[newData.branch_name].achievement = newData;
                        throttledRender();
                    }
                })
                .subscribe((status) => {
                    if (status === 'CHANNEL_ERROR') {
                        console.error('Realtime subscription error for daily_reports_achievements');
                    }
                });

            state.realtimeChannels.push(achievementChannel);
        }

        async function saveToSupabase(branchName, branchData, table) {
            const dateToSave = state.systemDate; // Expected YYYY-MM-DD

            // Get meta info
            const branchRow = state.rawData.rows.find(r => r[0] === branchName);
            const district = branchRow ? branchRow[1] : "";
            const dm = branchRow ? branchRow[2] : "";
            const region = branchRow ? branchRow[3] : "";

            // Helper: Convert string to number or null (fixes empty string "" vs 0 vs null)
            const toNum = (val) => {
                if (val === "" || val === null || val === undefined) return null;
                const n = Number(val);
                return isNaN(n) ? null : n;
            };

            // Flatten payload with Type Conversion
            const payload = {
                date: dateToSave,
                branch_name: branchName,
                region: region,
                district: district,
                dm_name: dm,

                // Map fields directly with conversion
                ftod_actual: toNum(branchData.ftod_actual),
                ftod_plan: toNum(branchData.ftod_plan),
                lived_actual: toNum(branchData.lived_actual),
                lived_plan: toNum(branchData.lived_plan),
                pnpa_actual: toNum(branchData.pnpa_actual),
                pnpa_plan: toNum(branchData.pnpa_plan),
                npa_activation: toNum(branchData.npa_activation),
                npa_closure: toNum(branchData.npa_closure),
                fy_od_acc: toNum(branchData.fy_od_acc),
                fy_od_plan: toNum(branchData.fy_od_plan),
                fy_non_start_acc: toNum(branchData.fy_non_start_acc),
                fy_non_start_plan: toNum(branchData.fy_non_start_plan),
                disb_sanc_pent_acc: toNum(branchData.disb_sanc_pent_acc),
                disb_sanc_pent_amt: toNum(branchData.disb_sanc_pent_amt),
                disb_igl_acc: toNum(branchData.disb_igl_acc),
                disb_igl_amt: toNum(branchData.disb_igl_amt),
                disb_il_acc: toNum(branchData.disb_il_acc),
                disb_il_amt: toNum(branchData.disb_il_amt),
                kyc_fig_igl: toNum(branchData.kyc_fig_igl),
                kyc_il: toNum(branchData.kyc_il),
                kyc_npa: toNum(branchData.kyc_npa)
            };

            console.log("Saving Payload to", table, payload);

            const { data, error } = await supabase
                .from(table)
                .upsert(payload, { onConflict: 'date,branch_name' })
                .select();

            console.log("Supabase Response:", { data, error });

            if (error) {
                console.error("Supabase Save Error:", error);
                // Show detailed error to help user debug RLS/Type issues
                alert(`Save Failed: ${error.message}\nHint: Check RLS policies or column types.`);
                return { success: false, error };
            }
            return { success: true, row: (data && data[0]) ? data[0] : payload };
        }

        // --- THEME ---
        function toggleTheme() {
            document.body.classList.toggle("dark-mode");
        }

        function toggleSidebar() {
            const sidebar = document.getElementById("sidebar");
            const overlay = document.getElementById("sidebarOverlay");
            sidebar.classList.toggle("open");
            overlay.classList.toggle("visible");
        }

        // --- ACTIONS ---
        function handleLogin(role) {
            let user = "";
            if (role === 'CEO') {
                user = "CEO";
                state.role = 'CEO';
            } else {
                user = document.getElementById("dmSelect").value;
                if (!user) return alert("Please select a manager.");
                state.role = 'DM';
            }
            state.currentUser = user;

            // CEO: Skip date overlay, auto-select today
            if (role === 'CEO') {
                autoLoginCEO();
                return;
            }

            // DM: SHOW INTERACTIVE DATE SELECTION OVERLAY
            const dailyOverlay = document.getElementById("daily-overlay");
            const loginOverlay = document.getElementById("login-overlay");

            // 1. Show Selection Overlay
            dailyOverlay.classList.remove("hidden");
            dailyOverlay.style.background = "white"; // Solid background

            // Hide Login Overlay
            loginOverlay.style.opacity = '0';
            setTimeout(() => loginOverlay.classList.add("hidden"), 500);

            // 2. Start Clock and Populate Buttons
            startOverlayClock();
            populateOverlayDates();
        }

        // CEO Quick Login - Auto-select today's date
        async function autoLoginCEO() {
            const loginOverlay = document.getElementById("login-overlay");

            // Hide login overlay immediately
            loginOverlay.style.opacity = '0';
            setTimeout(() => loginOverlay.classList.add("hidden"), 300);

            // Set today's date
            const now = new Date();
            const offsetDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000));
            const isoDate = offsetDate.toISOString().split('T')[0];
            state.systemDate = isoDate;

            // Fetch Data for today
            await fetchSupabaseData();

            // Update Header Display
            updateHeaderDate(isoDate);

            // Load App UI
            loadAppUI();
        }

        let clockInterval;
        function startOverlayClock() {
            const timeEl = document.getElementById("overlay-time");
            const dateEl = document.getElementById("overlay-date");

            const update = () => {
                const now = new Date();
                timeEl.textContent = now.toLocaleTimeString('en-US', { hour12: false });
                dateEl.textContent = now.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
            };
            update();
            clockInterval = setInterval(update, 1000);
        }

        function populateOverlayDates() {
            const now = new Date();

            // Helper for formatting "12 Jan"
            const fmt = (d) => d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });

            // Today
            document.getElementById("btn-date-0").textContent = fmt(now);

            // Tomorrow
            const tom = new Date(now); tom.setDate(tom.getDate() + 1);
            document.getElementById("btn-date-1").textContent = fmt(tom);

            // Day After
            const dat = new Date(now); dat.setDate(dat.getDate() + 2);
            document.getElementById("btn-date-2").textContent = fmt(dat);
        }

        async function selectSystemDate(offset) {
            clearInterval(clockInterval);

            // Calculate Target Date
            const targetDateObj = new Date();
            targetDateObj.setDate(targetDateObj.getDate() + offset);

            // Fix: Use local time YYYY-MM-DD instead of ISO (which is UTC)
            const offsetDate = new Date(targetDateObj.getTime() - (targetDateObj.getTimezoneOffset() * 60000));
            const isoDate = offsetDate.toISOString().split('T')[0];

            state.systemDate = isoDate;
            console.log("System Date Selected:", isoDate);

            // Fetch Data for this Date
            await fetchSupabaseData();

            // Update Header Display
            updateHeaderDate(isoDate);

            // Transition to App
            const dailyOverlay = document.getElementById("daily-overlay");
            dailyOverlay.style.opacity = '0';
            setTimeout(() => {
                dailyOverlay.classList.add("hidden");
                loadAppUI();
            }, 500);
        }

        function loadAppUI() {
            // Show Main Content
            document.getElementById("sidebar").classList.remove("hidden");
            document.querySelector(".main-content").classList.remove("hidden");

            // Update Header Info
            const role = state.role;
            const user = state.currentUser;
            document.getElementById("headerName").textContent = user;
            document.getElementById("headerRole").textContent = role === 'CEO' ? "Suresh B K" : "District Manager";
            document.getElementById("headerAvatar").textContent = user.charAt(0);

            // Disable Sidebar items for DM
            if (role === 'DM') {
                document.getElementById('nav-dashboard').classList.add('hidden');
                // Auto switch to hierarchy
                switchTab('hierarchy');
            } else {
                document.getElementById('nav-dashboard').classList.remove('hidden');
                renderDashboard();
            }
        }

        function handleLogout() {
            location.reload();
        }

        function switchTab(tab) {
            state.activeTab = tab;
            document.querySelectorAll(".nav-item").forEach(el => el.classList.remove("active"));

            if (tab === 'dashboard') {
                document.querySelectorAll(".nav-item")[0].classList.add("active");
                document.getElementById("breadcrumbs").innerHTML = 'Home / <span>Dashboard</span>';
            }
            if (tab === 'hierarchy') {
                document.querySelectorAll(".nav-item")[1].classList.add("active");
                document.getElementById("breadcrumbs").innerHTML = 'Home / <span>Detailed View</span>';
                state.viewStack = []; // Reset drill-down
            }

            // Auto-close sidebar on mobile if open
            if (window.innerWidth <= 768) {
                document.getElementById("sidebar").classList.remove("open");
                document.getElementById("sidebarOverlay").classList.remove("visible");
            }

            renderDashboard();
        }

        let toastTimeout = null;
        function showToast(msg, icon = 'info') {
            const toast = document.getElementById("toast");
            const toastMsg = document.getElementById("toastMsg");
            if (!toast || !toastMsg) return;

            // Clear any existing timeout to prevent stacking
            if (toastTimeout) {
                clearTimeout(toastTimeout);
                toast.classList.remove("visible");
            }

            toastMsg.textContent = msg;
            toast.classList.add("visible");

            toastTimeout = setTimeout(() => {
                toast.classList.remove("visible");
                toastTimeout = null;
            }, 3000);
        }

        // --- DRILL DOWN ACTIONS ---
        function pushStack(name, data) {
            state.viewStack.push({ name, data });
            renderDashboard();
        }

        function popStack() {
            state.viewStack.pop();
            renderDashboard();
        }

        // --- SEED / DELETE DATA ---



        // --- RENDERERS ---
        function renderDashboard() {
            const container = document.getElementById("dashboard-container");

            // 1. Safe Render Buffer
            const buffer = document.createElement("div");
            buffer.className = "dashboard-grid fade-enter";

            try {
                // 1. DASHBOARD TAB
                if (state.activeTab === 'dashboard') {
                    if (state.role === 'CEO') {
                        const stats = calculateCEOStats();

                        // ============ ROW 1: EXECUTIVE SUMMARY (4 Cards) ============
                        buffer.innerHTML += `
                            <div class="metric-card clickable-metric" onclick="openDetailModal('completion')">
                                <div class="metric-header">
                                    <div class="metric-icon" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white;">
                                        <svg class="icon" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                                    </div>
                                    <div class="metric-badge ${stats.completionRate >= 80 ? 'badge-up' : ''}" style="${stats.completionRate < 80 ? 'background: #FEF3C7; color: #D97706;' : ''}">
                                        ${stats.completionRate >= 80 ? 'âœ“ On Track' : 'âš  Pending'}
                                    </div>
                                </div>
                                <div>
                                    <div class="metric-title">Completion Rate</div>
                                    <div class="metric-value">${stats.completionRate}%</div>
                                    <div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">${stats.completedBranches} of ${stats.totalBranches} branches Â· Click for details</div>
                                </div>
                            </div>

                            <div class="metric-card clickable-metric" onclick="openDetailModal('branches')">
                                <div class="metric-header">
                                    <div class="metric-icon" style="background: linear-gradient(135deg, #6366F1 0%, #4F46E5 100%); color: white;">
                                        <svg class="icon" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg>
                                    </div>
                                </div>
                                <div>
                                    <div class="metric-title">Active Branches</div>
                                    <div class="metric-value">${stats.totalBranches}</div>
                                    <div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">${Object.keys(stats.regionStats).length} Regions Â· Click for details</div>
                                </div>
                            </div>

                            <div class="metric-card clickable-metric" onclick="openDetailModal('achievement')">
                                <div class="metric-header">
                                    <div class="metric-icon" style="background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); color: white;">
                                        <svg class="icon" viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
                                    </div>
                                    <div class="metric-badge badge-up">
                                        <svg class="icon" style="width:12px;height:12px;" viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline></svg>
                                        ${stats.avgAchievementPct}% Avg
                                    </div>
                                </div>
                                <div>
                                    <div class="metric-title">Overall Achievement</div>
                                    <div class="metric-value">${stats.avgAchievementPct}%</div>
                                    <div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">Across all metrics Â· Click for details</div>
                                </div>
                            </div>

                            <div class="metric-card clickable-metric" onclick="openDetailModal('collection')">
                                <div class="metric-header">
                                    <div class="metric-icon" style="background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%); color: white;">
                                        <svg class="icon" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                                    </div>
                                </div>
                                <div>
                                    <div class="metric-title">Today's Collection Target</div>
                                    <div class="metric-value">â‚¹${(stats.totalCollectionTarget / 100000).toFixed(1)}L</div>
                                    <div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">FTOD + Slipped + PNPA Â· Click for details</div>
                                </div>
                            </div>
                        `;

                        // ============ ROW 2: COLLECTION PERFORMANCE ============
                        buffer.innerHTML += `
                            <div class="chart-card grid-full">
                                <div class="chart-header">
                                    <div class="chart-title">ðŸ“Š Collection Performance</div>
                                    <div style="font-size:11px; color:var(--text-secondary);">Target vs Achievement</div>
                                </div>
                                <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:20px; padding:20px 0;">
                                    <div class="clickable-section" onclick="openDetailModal('ftod')">${renderCollectionMetric('FTOD', stats.ftodTarget, stats.ftodAchieve)}</div>
                                    <div class="clickable-section" onclick="openDetailModal('slipped')">${renderCollectionMetric('Slipped (LIVED)', stats.livedTarget, stats.livedAchieve)}</div>
                                    <div class="clickable-section" onclick="openDetailModal('pnpa')">${renderCollectionMetric('PNPA', stats.pnpaTarget, stats.pnpaAchieve)}</div>
                                    <div class="clickable-section" onclick="openDetailModal('npa')">${renderNPAMovement(stats.npaActivation, stats.npaClosure)}</div>
                                </div>
                            </div>
                        `;

                        // ============ ROW 3: PORTFOLIO HEALTH + DISBURSEMENT ============
                        buffer.innerHTML += `
                            <div class="chart-card grid-half clickable-section" onclick="openDetailModal('portfolio')">
                                <div class="chart-header">
                                    <div class="chart-title">ðŸ¦ Portfolio Health</div>
                                    <div style="font-size:11px; color:var(--text-secondary);">Click for details</div>
                                </div>
                                <div class="bar-chart-container" style="align-items:center; justify-content:center; flex-direction:row;" id="portfolioDonutHook"></div>
                            </div>

                            <div class="chart-card grid-half">
                                <div class="chart-header">
                                    <div class="chart-title">ðŸ’° Disbursement Summary</div>
                                    <div style="font-size:18px; font-weight:700; color:var(--success);">â‚¹${(stats.totalDisbursement / 10000000).toFixed(2)} Cr</div>
                                </div>
                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; padding:16px 0;">
                                    <div class="clickable-section" onclick="openDetailModal('disb_sanction')" style="background:var(--bg-body); padding:16px; border-radius:12px; text-align:center; cursor:pointer;">
                                        <div style="font-size:11px; color:var(--text-secondary); margin-bottom:4px;">Sanction Pending</div>
                                        <div style="font-size:20px; font-weight:700; color:var(--primary-accent);">${stats.disbSancAcc}</div>
                                        <div style="font-size:11px; color:var(--text-secondary);">â‚¹${(stats.disbSancAmt / 100000).toFixed(1)}L</div>
                                    </div>
                                    <div class="clickable-section" onclick="openDetailModal('disb_igl')" style="background:var(--bg-body); padding:16px; border-radius:12px; text-align:center; cursor:pointer;">
                                        <div style="font-size:11px; color:var(--text-secondary); margin-bottom:4px;">IGL & FIG</div>
                                        <div style="font-size:20px; font-weight:700; color:#10B981;">${stats.disbIglAcc}</div>
                                        <div style="font-size:11px; color:var(--text-secondary);">â‚¹${(stats.disbIglAmt / 100000).toFixed(1)}L</div>
                                    </div>
                                    <div class="clickable-section" onclick="openDetailModal('disb_il')" style="background:var(--bg-body); padding:16px; border-radius:12px; text-align:center; cursor:pointer;">
                                        <div style="font-size:11px; color:var(--text-secondary); margin-bottom:4px;">IL</div>
                                        <div style="font-size:20px; font-weight:700; color:#F59E0B;">${stats.disbIlAcc}</div>
                                        <div style="font-size:11px; color:var(--text-secondary);">â‚¹${(stats.disbIlAmt / 100000).toFixed(1)}L</div>
                                    </div>
                                    <div class="clickable-section" onclick="openDetailModal('disbursement')" style="background:var(--primary-light); padding:16px; border-radius:12px; text-align:center; cursor:pointer;">
                                        <div style="font-size:11px; color:var(--primary-accent); margin-bottom:4px;">Total Accounts</div>
                                        <div style="font-size:20px; font-weight:700; color:var(--primary-accent);">${stats.disbSancAcc + stats.disbIglAcc + stats.disbIlAcc}</div>
                                        <div style="font-size:11px; color:var(--text-secondary);">Click for all details</div>
                                    </div>
                                </div>
                            </div>
                        `;

                        // ============ ROW 4: REGIONAL PERFORMANCE ============
                        buffer.innerHTML += `
                            <div class="table-card grid-full">
                                <div class="chart-header">
                                    <div class="chart-title">ðŸŒ Regional Performance</div>
                                </div>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Region</th>
                                            <th>Branches</th>
                                            <th>Completed</th>
                                            <th>Avg Achievement</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="regionalTableHook"></tbody>
                                </table>
                            </div>
                        `;

                        // ============ ROW 5: QUICK INSIGHTS ============
                        buffer.innerHTML += `
                            <div class="chart-card grid-half">
                                <div class="chart-header">
                                    <div class="chart-title">âš¡ Pending Actions</div>
                                </div>
                                <div style="display:flex; flex-direction:column; gap:12px; padding:12px 0;">
                                    <div class="clickable-row" onclick="openDetailModal('pending')" style="display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:${stats.pendingAchievement > 0 ? '#FEF3C7' : 'var(--bg-body)'}; border-radius:10px; cursor:pointer;">
                                        <div style="display:flex; align-items:center; gap:10px;">
                                            <span style="font-size:18px;">ðŸŽ¯</span>
                                            <span style="font-weight:500;">Branches with only Targets</span>
                                        </div>
                                        <span style="font-size:18px; font-weight:700; color:${stats.pendingAchievement > 0 ? '#D97706' : 'var(--success)'};">${stats.pendingAchievement} â†’</span>
                                    </div>
                                    <div class="clickable-row" onclick="openDetailModal('nodata')" style="display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:${stats.noDataBranches > 0 ? '#FEE2E2' : 'var(--bg-body)'}; border-radius:10px; cursor:pointer;">
                                        <div style="display:flex; align-items:center; gap:10px;">
                                            <span style="font-size:18px;">â³</span>
                                            <span style="font-weight:500;">Branches with No Data</span>
                                        </div>
                                        <span style="font-size:18px; font-weight:700; color:${stats.noDataBranches > 0 ? '#DC2626' : 'var(--success)'};">${stats.noDataBranches} â†’</span>
                                    </div>
                                    <div class="clickable-row" onclick="openDetailModal('completed')" style="display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:var(--success-light); border-radius:10px; cursor:pointer;">
                                        <div style="display:flex; align-items:center; gap:10px;">
                                            <span style="font-size:18px;">âœ…</span>
                                            <span style="font-weight:500;">Fully Completed</span>
                                        </div>
                                        <span style="font-size:18px; font-weight:700; color:var(--success);">${stats.completedBranches} â†’</span>
                                    </div>
                                </div>
                            </div>

                            <div class="chart-card grid-half clickable-section" onclick="openDetailModal('kyc')">
                                <div class="chart-header">
                                    <div class="chart-title">ðŸ“‹ KYC Sourcing Summary</div>
                                    <div style="font-size:14px; font-weight:700; color:var(--primary-accent);">${stats.kycTotal} Total Â· Click for details</div>
                                </div>
                                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; padding:16px 0;">
                                    <div style="background:linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%); padding:20px 16px; border-radius:12px; text-align:center;">
                                        <div style="font-size:24px; font-weight:700; color:#6366F1;">${stats.kycFigIgl}</div>
                                        <div style="font-size:11px; color:#4F46E5; margin-top:4px;">FIG & IGL</div>
                                    </div>
                                    <div style="background:linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); padding:20px 16px; border-radius:12px; text-align:center;">
                                        <div style="font-size:24px; font-weight:700; color:#D97706;">${stats.kycIl}</div>
                                        <div style="font-size:11px; color:#B45309; margin-top:4px;">IL</div>
                                    </div>
                                    <div style="background:linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%); padding:20px 16px; border-radius:12px; text-align:center;">
                                        <div style="font-size:24px; font-weight:700; color:#059669;">${stats.kycNpa}</div>
                                        <div style="font-size:11px; color:#047857; margin-top:4px;">NPA</div>
                                    </div>
                                </div>
                            </div>
                        `;

                        // --- COMMIT TO DOM ---
                        container.innerHTML = "";
                        container.appendChild(buffer);

                        // Render Charts (Must happen after commit)
                        renderPortfolioDonut(stats.portfolioHealth, document.getElementById("portfolioDonutHook"));
                        renderRegionalTable(stats.regionalBreakdown, document.getElementById("regionalTableHook"));
                    } else {
                        const tableCard = document.createElement("div");
                        tableCard.className = "table-card grid-full";
                        tableCard.innerHTML = `
                            <div class="chart-header">
                                <div class="chart-title">Branch Performance Targets</div>
                                <button class="btn btn-primary" onclick="saveTargets()" style="width:auto; padding:8px 16px;">Save Changes</button>
                            </div>
                            <table>
                                <thead><tr><th>District</th><th>Branch</th><th>Target Input</th><th>Status</th></tr></thead>
                                <tbody id="dmTableHook"></tbody>
                            </table>`;

                        buffer.appendChild(tableCard);
                        container.innerHTML = "";
                        container.appendChild(buffer);

                        renderDMTable(document.getElementById("dmTableHook"));
                    }
                }

                // 2. DETAILED VIEW / DRILL DOWN
                else if (state.activeTab === 'hierarchy') {
                    const wrapper = document.createElement("div");
                    wrapper.className = "table-card grid-full";

                    // Determine Current Level
                    let currentData = state.fullTree;
                    let currentTitle = "All Regions";
                    let currentType = "Region";

                    // DM SPECIFIC OVERRIDE
                    if (state.role === 'DM') {
                        const dmNode = getDMNode();
                        if (dmNode) {
                            currentData = dmNode;
                            currentTitle = "My Districts";
                            currentType = "District"; // Root for DM is District list
                        }
                    }

                    if (state.viewStack.length > 0) {
                        const top = state.viewStack[state.viewStack.length - 1];
                        currentData = top.data;
                        currentTitle = top.name;

                        if (state.role === 'DM') {
                            if (state.viewStack.length === 1) currentType = "Branch";
                        } else {
                            // CEO Logic
                            if (state.viewStack.length === 1) currentType = "DM";
                            if (state.viewStack.length === 2) currentType = "District";
                            if (state.viewStack.length === 3) currentType = "Branch";
                        }
                    }

                    // Header with Back Button
                    wrapper.innerHTML = `
                        <div class="chart-header" style="justify-content:flex-start; gap:16px;">
                            ${state.viewStack.length > 0 ?
                            `<button class="btn btn-outline" onclick="popStack()" style="width:auto; padding:8px 12px;">
                                    <svg class="icon" viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                                 </button>`
                            : ''}
                            <div class="chart-title">${currentTitle}</div>
                        </div>
                        <div id="drillDownGrid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:16px; padding-top:10px;"></div>
                    `;

                    buffer.appendChild(wrapper);
                    container.innerHTML = "";
                    container.appendChild(buffer);

                    const ddGrid = document.getElementById("drillDownGrid");

                    // Render Items
                    if (currentData instanceof Set) {
                        // Leaf Nodes (Branches)
                        currentData.forEach(name => {
                            ddGrid.appendChild(createDrillDownCard(name, "Branch", null, true));
                        });
                    } else {
                        Object.keys(currentData).sort().forEach(key => {
                            ddGrid.appendChild(createDrillDownCard(key, currentType, currentData[key], false));
                        });
                    }
                }
            } catch (err) {
                console.error("Render Error:", err);
                showToast("Error rendering dashboard. Please refresh.", "alert");
            }
        }

        // --- COMPONENTS ---
        function createMetricCard(title, value, iconType, isSuccess = false) {
            const icons = {
                "trending-up": `<polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline>`,
                "activity": `<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>`,
                "bar-chart": `<line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line>`,
                "award": `<circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>`
            };

            return `
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon">
                        <svg class="icon" viewBox="0 0 24 24">${icons[iconType]}</svg>
                    </div>
                     ${isSuccess ? '<div class="metric-badge badge-up"><svg class="icon" style="width:12px;height:12px;" viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline></svg> +12%</div>' : ''}
                </div>
                <div>
                    <div class="metric-title">${title}</div>
                    <div class="metric-value">${value}</div>
                </div>
            </div>`;
        }

        function createDrillDownCard(name, type, children, isLeaf) {
            const card = document.createElement("div");
            card.style.cssText = `
        background: var(--bg-body); border-radius: 12px; padding: 16px;
        cursor: pointer; transition: background 0.2s; border: 1px solid var(--border-color);
        display: flex; flex-direction: column; gap: 8px;
    `;

            // Calculate Average Percentage instead of total
            let displayValue = '--';
            let valueColor = 'var(--text-secondary)';

            if (isLeaf) {
                const avgPct = calculateBranchAveragePercentage(name);
                if (avgPct !== null) {
                    displayValue = avgPct + '%';
                    // Color coding based on percentage
                    if (avgPct >= 100) valueColor = 'var(--success)';
                    else if (avgPct >= 50) valueColor = '#F59E0B'; // Warning yellow
                    else valueColor = '#EF4444'; // Red
                }
            } else {
                const avgPct = calculateAveragePercentage(type, name, children);
                if (avgPct !== null) {
                    displayValue = avgPct + '%';
                    // Color coding based on percentage
                    if (avgPct >= 100) valueColor = 'var(--success)';
                    else if (avgPct >= 50) valueColor = '#F59E0B'; // Warning yellow
                    else valueColor = '#EF4444'; // Red
                }
            }

            card.innerHTML = `
        <div style="font-size:12px; color:var(--text-secondary); text-transform:uppercase; font-weight:600;">${type}</div>
        <div style="font-size:15px; font-weight:600; color:var(--text-primary);">${name}</div>
        <div style="font-size:18px; font-weight:700; color:${valueColor}; margin-top:auto;">${displayValue}</div>
    `;

            if (!isLeaf) {
                card.onclick = () => pushStack(name, children);
                card.onmouseover = () => card.style.background = "var(--primary-light)";
                card.onmouseout = () => card.style.background = "var(--bg-body)";
            } else {
                // LEAF NODE (BRANCH) - 3 STATE LOGIC
                const branchEntry = state.branchDetails[name];
                const hasTarget = branchEntry && branchEntry.target;
                const hasAchieve = branchEntry && branchEntry.achievement;

                // STATE 3: FULL GREEN (DONE)
                if (hasTarget && hasAchieve) {
                    card.innerHTML += `<div style="margin-top:4px; font-size:11px; color:var(--success); display:flex; align-items:center; gap:4px;">
                        <svg class="icon" style="width:12px;height:12px;" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg> Completed
                     </div>`;
                    card.style.border = "1px solid var(--success-light)";
                    card.style.background = "var(--success-light)";
                    card.querySelector("div:nth-child(2)").style.color = "var(--success)"; // Text Green
                }
                // STATE 2: GREEN OUTLINE (PENDING ACHIEVEMENT)
                else if (hasTarget && !hasAchieve) {
                    card.innerHTML += `<div style="margin-top:4px; font-size:11px; color:var(--success); display:flex; align-items:center; gap:4px;">
                        <svg class="icon" style="width:12px;height:12px;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle></svg> Set Achievement
                     </div>`;
                    card.style.border = "2px solid var(--success)"; // Thicker Border
                    card.style.background = "var(--bg-card)";
                }
                // STATE 1: DEFAULT (SET TARGET)
                else {
                    card.innerHTML += `<div style="margin-top:4px; font-size:11px; color:var(--warning); display:flex; align-items:center; gap:4px;">
                        <svg class="icon" style="width:12px;height:12px;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle></svg> Set Target
                     </div>`;
                    card.style.border = "1px solid var(--border-color)";
                    // card.style.background stays default
                }

                card.onclick = () => openBranchModal(name);
                card.onmouseover = () => { if (!(hasTarget && hasAchieve)) card.style.background = "var(--primary-light)"; }
                card.onmouseout = () => { if (!(hasTarget && hasAchieve)) card.style.background = "var(--bg-body)"; }
                card.style.cursor = "pointer";
            }

            return card;
        }

        // --- VIEW SUMMARY WITH PERCENTAGES ---
        function createViewSummary(targetData, achieveData) {
            // Helper to safely get number value
            const getVal = (data, field) => {
                if (!data) return 0;
                // Map IL fields to JL database columns
                // Columns now match form field IDs directly
                return Number(data[field]) || 0;
            };

            // Calculate percentage with color coding
            const calcPercent = (target, achieve) => {
                if (target === 0) return { pct: achieve > 0 ? 'âˆž' : '-', color: '#6B7280' };
                const pct = Math.round((achieve / target) * 100);
                let color = '#10B981'; // Green for â‰¥100%
                if (pct < 100) color = '#F59E0B'; // Yellow for 50-99%
                if (pct < 50) color = '#EF4444'; // Red for <50%
                return { pct: pct + '%', color };
            };

            // Create metric row HTML
            const metricRow = (label, targetField, achieveField) => {
                const t = getVal(targetData, targetField);
                const a = getVal(achieveData, achieveField || targetField);
                const { pct, color } = calcPercent(t, a);
                const progressWidth = t === 0 ? 0 : Math.min((a / t) * 100, 100);

                return `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid var(--border-color);">
                        <div style="flex:2; font-weight:500; color:var(--text-primary);">${label}</div>
                        <div style="flex:1; text-align:center; color:var(--text-secondary);">${t}</div>
                        <div style="flex:1; text-align:center; font-weight:600; color:var(--text-primary);">${a}</div>
                        <div style="flex:1; text-align:center;">
                            <span style="background:${color}20; color:${color}; padding:4px 12px; border-radius:20px; font-weight:700; font-size:13px;">${pct}</span>
                        </div>
                    </div>
                `;
            };

            // Create section HTML
            const section = (title, rows) => `
                <div style="background:var(--bg-card); border-radius:12px; padding:20px; margin-bottom:16px; box-shadow:var(--card-shadow);">
                    <div style="font-size:14px; font-weight:700; color:var(--primary-accent); text-transform:uppercase; margin-bottom:16px; letter-spacing:0.5px;">${title}</div>
                    <div style="display:flex; justify-content:space-between; padding:8px 0; margin-bottom:8px; border-bottom:2px solid var(--border-color);">
                        <div style="flex:2; font-size:11px; color:var(--text-secondary); font-weight:600;">METRIC</div>
                        <div style="flex:1; text-align:center; font-size:11px; color:var(--text-secondary); font-weight:600;">TARGET</div>
                        <div style="flex:1; text-align:center; font-size:11px; color:var(--text-secondary); font-weight:600;">ACHIEVED</div>
                        <div style="flex:1; text-align:center; font-size:11px; color:var(--text-secondary); font-weight:600;">%</div>
                    </div>
                    ${rows}
                </div>
            `;

            // Build HTML
            let html = `
                <div style="padding:20px;">
                    <div style="background:linear-gradient(135deg, #10B981 0%, #059669 100%); color:white; padding:16px 24px; border-radius:12px; margin-bottom:24px; text-align:center;">
                        <div style="font-size:14px; opacity:0.9;">Report Status</div>
                        <div style="font-size:20px; font-weight:700;">âœ“ Completed - Target & Achievement Saved</div>
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                        <div>
                            ${section('FTOD - Accounts',
                metricRow('Actual FTOD', 'ftod_actual') +
                metricRow('Collection Plan', 'ftod_plan')
            )}
                            
                            ${section('Slipped Accounts (Lived)',
                metricRow('Actual Account', 'lived_actual') +
                metricRow('Collection Plan', 'lived_plan')
            )}
                            
                            ${section('PNPA Accounts',
                metricRow('Actual PNPA', 'pnpa_actual') +
                metricRow('Collection Plan', 'pnpa_plan')
            )}
                            
                            ${section('NPA Accounts',
                metricRow('NPA Activation', 'npa_activation') +
                metricRow('NPA Closure', 'npa_closure')
            )}
                        </div>
                        <div>
                            ${section('FY 25-26 Accounts',
                metricRow('Total OD Accounts', 'fy_od_acc') +
                metricRow('OD Collection Plan', 'fy_od_plan') +
                metricRow('Non-Starter Accounts', 'fy_non_start_acc') +
                metricRow('Non-Starter Plan', 'fy_non_start_plan')
            )}
                            
                            ${section('Disbursement',
                metricRow('Sanction Pending (Acc)', 'disb_sanc_pent_acc') +
                metricRow('Sanction Pending (Amt)', 'disb_sanc_pent_amt') +
                metricRow('IGL & FIG (Acc)', 'disb_igl_acc') +
                metricRow('IGL & FIG (Amt)', 'disb_igl_amt') +
                metricRow('IL (Acc)', 'disb_il_acc') +
                metricRow('IL (Amt)', 'disb_il_amt')
            )}
                            
                            ${section('KYC Sourcing',
                metricRow('FIG and IGL', 'kyc_fig_igl') +
                metricRow('IL', 'kyc_il') +
                metricRow('NPA', 'kyc_npa')
            )}
                        </div>
                    </div>
                </div>
            `;

            return html;
        }

        // --- BRANCH DETAILS MODAL LOGIC ---
        let currentEditingBranch = null;

        // Track current modal state for use in save function
        let currentModalState = 'TARGET';

        function openBranchModal(branchName) {
            currentEditingBranch = branchName;
            document.getElementById("modalBranchTitle").textContent = `${branchName} - Details`;

            // GET STATE
            const branchEntry = state.branchDetails[branchName] || {};
            const targetData = branchEntry.target;
            const achieveData = branchEntry.achievement;

            // 1. STATE DETECTION
            currentModalState = 'TARGET'; // Default: State 1
            if (targetData && !achieveData) currentModalState = 'ACHIEVEMENT'; // State 2
            if (targetData && achieveData) currentModalState = 'VIEW'; // State 3

            // Local alias for use in this function
            let reportState = currentModalState;

            // Helper lists
            const planFields = [
                'ftod_plan', 'lived_plan', 'pnpa_plan', 'fy_od_plan', 'fy_non_start_plan'
            ];
            const achieveFields = [
                'ftod_actual', 'lived_actual', 'pnpa_actual', 'npa_activation', 'npa_closure',
                'fy_od_acc', 'fy_non_start_acc',
                'disb_sanc_pent_acc', 'disb_sanc_pent_amt', 'disb_igl_acc', 'disb_igl_amt',
                'disb_il_acc', 'disb_il_amt',
                'kyc_fig_igl', 'kyc_il', 'kyc_npa'
            ];

            const modalContainer = document.querySelector(".modal-container");
            const footer = document.querySelector(".modal-footer");

            // Clean banners
            const existingBanner = document.querySelector(".read-only-banner");
            if (existingBanner) existingBanner.remove();

            // Clean up any VIEW mode elements
            const existingSummary = document.getElementById("view-summary-container");
            if (existingSummary) existingSummary.remove();

            // Reset panels visibility (in case they were hidden by VIEW mode)
            const leftPanel = document.querySelector(".modal-body .left-panel");
            const rightPanel = document.querySelector(".modal-body .right-panel");
            if (leftPanel) leftPanel.style.display = '';
            if (rightPanel) rightPanel.style.display = '';

            modalContainer.classList.remove("read-only-mode"); // Reset
            footer.style.display = 'flex'; // Reset footer

            // 2. APPLY STATE UI
            if (reportState === 'TARGET') {
                // STATE 1: SET TARGET
                // ALL UNLOCKED
                const banner = document.createElement("div");
                banner.className = "read-only-banner";
                banner.style.background = "#FFC10720"; // Light Yellow
                banner.style.color = "#D97706";
                banner.style.border = "1px solid #D97706";
                banner.textContent = "Step 1: Set Daily Targets";
                document.querySelector(".modal-body").prepend(banner);

                planFields.forEach(id => {
                    const el = document.getElementById(id);
                    el.value = "";
                    el.disabled = false;
                });
                achieveFields.forEach(id => {
                    const el = document.getElementById(id);
                    el.value = "";
                    el.disabled = false; // UNLOCKED
                });
            }
            else if (reportState === 'ACHIEVEMENT') {
                // STATE 2: SET ACHIEVEMENT
                // ALL UNLOCKED (Allow editing targets too)
                const banner = document.createElement("div");
                banner.className = "read-only-banner";
                banner.style.background = "#D1FAE5"; // Light Green
                banner.style.color = "#059669";
                banner.textContent = "Step 2: Enter Achievements (Targets Editable)";
                document.querySelector(".modal-body").prepend(banner);

                // Define mappings
                const pairs = {
                    'ftod_actual': 'ftod_plan',
                    'lived_actual': 'lived_plan',
                    'pnpa_actual': 'pnpa_plan',
                    'fy_od_acc': 'fy_od_plan',
                    'fy_non_start_acc': 'fy_non_start_plan'
                };

                // DYNAMICALLY HANDLE ALL NON-PLAN INPUTS
                const allInputs = document.querySelectorAll('.modal-body input');

                allInputs.forEach(input => {

                    const id = input.id;
                    if (!id || input.type === 'checkbox') return;

                    // UNIVERSAL LOGIC: Clear Value, Show Placeholder
                    input.value = "";
                    input.disabled = false;

                    // Determine Target Key - map form fields to database columns
                    let targetKey = pairs[id] || id;
                    // Map form field to database column for IL fields
                    // Columns now match form field IDs directly

                    if (targetData && targetData[targetKey] !== undefined && targetData[targetKey] !== null && targetData[targetKey] !== "") {
                        input.placeholder = `Target: ${targetData[targetKey]}`;
                    } else {
                        input.placeholder = "Enter Achievement...";
                    }
                });
            }
            else {
                // STATE 3: VIEW ONLY - Beautiful UI with Percentage Calculations
                modalContainer.classList.add("read-only-mode");

                // Hide left and right panels (the form sections)
                const leftPanel = document.querySelector(".modal-body .left-panel");
                const rightPanel = document.querySelector(".modal-body .right-panel");
                if (leftPanel) leftPanel.style.display = 'none';
                if (rightPanel) rightPanel.style.display = 'none';

                // Remove any existing summary container
                const existingSummary = document.getElementById("view-summary-container");
                if (existingSummary) existingSummary.remove();

                // Create beautiful summary view
                const summaryHTML = createViewSummary(targetData, achieveData);
                const summaryContainer = document.createElement("div");
                summaryContainer.id = "view-summary-container";
                summaryContainer.style.gridColumn = "1 / -1"; // Span full width
                summaryContainer.innerHTML = summaryHTML;
                document.querySelector(".modal-body").appendChild(summaryContainer);
            }



            // Inject Test Connection
            const btnTestId = "btn-test-conn";
            if (!document.getElementById(btnTestId)) {
                const btn = document.createElement("button");
                btn.id = btnTestId;
                btn.className = "btn btn-outline";
                btn.style.width = "auto";
                btn.style.fontSize = "10px";
                btn.style.padding = "4px 8px";
                btn.innerText = "Test Connection";
                btn.onclick = testSupabaseConnection;
                // Prepend to footer or right panel? Footer is best
                footer.insertBefore(btn, footer.firstChild);
            }

            document.getElementById("branchModal").classList.add("visible");
        }

        function closeBranchModal() {
            document.getElementById("branchModal").classList.remove("visible");
            currentEditingBranch = null;
        }


        async function saveBranchDetails(andNext) {
            if (!currentEditingBranch) return;

            // Use the tracked modal state instead of re-calculating from state.branchDetails
            // This ensures the correct table is used even if state hasn't been refreshed
            const saveMode = currentModalState;

            console.log("Save Mode:", saveMode, "| Branch:", currentEditingBranch, "| Modal State:", currentModalState);

            // Don't save in VIEW mode
            if (saveMode === 'VIEW') {
                showToast("View mode - no changes to save", "alert");
                return;
            }

            const data = {};
            // Fields to capture based on mode
            // If Mode TARGET: Capture Plan, Zero Actuals
            // If Mode ACHIEVEMENT: Capture Actuals, Keep Plan from Target Record

            const allFields = [
                'ftod_actual', 'ftod_plan', 'lived_actual', 'lived_plan',
                'pnpa_actual', 'pnpa_plan', 'npa_activation', 'npa_closure',
                'fy_od_acc', 'fy_od_plan', 'fy_non_start_acc', 'fy_non_start_plan',
                'disb_sanc_pent_acc', 'disb_sanc_pent_amt', 'disb_igl_acc', 'disb_igl_amt',
                'disb_il_acc', 'disb_il_amt',
                'kyc_fig_igl', 'kyc_il', 'kyc_npa'
            ];

            // Reset any error styling from previous attempts
            allFields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove("input-error");
            });

            // 1. Validate for empty fields - check all visible/enabled inputs
            for (const id of allFields) {
                const el = document.getElementById(id);
                if (el) {
                    // Check if the input is visible and not disabled/readonly
                    const isVisible = el.offsetParent !== null;
                    const isEnabled = !el.disabled && !el.readOnly;

                    // Check if empty (trim to handle whitespace-only values)
                    const value = el.value.trim();

                    if (isVisible && isEnabled && value === '') {
                        // Add error styling
                        el.classList.add("input-error");
                        // Focus on the empty field
                        el.focus();
                        // Scroll the input into view if needed
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // Show error message
                        showToast("Enter an amount; if it does not apply, type 0 instead of leaving it empty.", "alert");
                        return; // Stop save process
                    }
                }
            }

            // 2. Gather Data from Form
            // Note: Even locked fields return values, which is good for copying Plans in Achievement Mode
            for (const id of allFields) {
                const el = document.getElementById(id);
                if (el) {
                    // No longer requiring all fields - allow empty values
                    // Empty values will be sent as empty string and converted to null/0 by saveToSupabase
                    data[id] = el.value;
                }
            }

            console.log("Collected data from form:", data);
            console.log("Saving to table:", saveMode === 'TARGET' ? 'daily_reports' : 'daily_reports_achievements');

            // 2. Prepare Payload based on Mode
            // If ACHIEVEMENT mode, we need to ensure PLAN values are preserved from the Target record
            // However, since we populate them into the inputs (locked), reading the input value `data[id]` works perfectly.

            // 3. Save
            const table = saveMode === 'TARGET' ? 'daily_reports' : 'daily_reports_achievements';

            // Persist
            const result = await saveToSupabase(currentEditingBranch, data, table);

            if (!result || !result.success) {
                // Toast already shown in saveToSupabase
                return;
            }

            // Use DB-returned row; columns now match form field IDs directly
            const savedRow = result.row || {};
            const normalized = {
                ...savedRow,
                branch_name: currentEditingBranch,
                date: state.systemDate
            };

            // Optimistic Update
            if (!state.branchDetails[currentEditingBranch]) state.branchDetails[currentEditingBranch] = {};

            if (saveMode === 'TARGET') state.branchDetails[currentEditingBranch].target = normalized;
            else state.branchDetails[currentEditingBranch].achievement = normalized;

            showToast(`Details Saved (${saveMode === 'TARGET' ? 'Target' : 'Achievement'})`, "check");

            if (andNext) {
                loadNextBranch();
            } else {
                closeBranchModal();
            }
            // Refresh view to show checkmark
            try {
                if (state.activeTab === 'hierarchy') renderDashboard();
            } catch (e) {
                console.error("Error updating dashboard:", e);
                showToast("Saved, but view refresh failed.", "alert");
            }
        }

        async function testSupabaseConnection() {
            showToast("Testing connection...", "info");
            const { data, error } = await supabase.from('daily_reports').select('*').limit(1);
            if (error) {
                showToast("Connection Failed: " + error.message, "alert");
                console.error("Supabase Test Error:", error);
            } else {
                showToast("Connection Successful!", "check");
                console.log("Supabase Test Data:", data);
            }
        }

        function loadNextBranch() {
            // Flatten hierarchy to find next branch
            // Filter by DM if Role is DM
            let allBranches = [];

            if (state.role === 'DM') {
                const idxDM = state.rawData.headers.findIndex(h => h.trim().toLowerCase() === "dm name");
                // Get rows for this DM
                const dmRows = state.rawData.rows.filter(r => (r[idxDM] || "").trim() === state.currentUser);
                // Extract branch names and sort
                allBranches = dmRows.map(r => r[0]).filter(Boolean).sort();
            } else {
                // CEO sees all
                allBranches = state.rawData.rows.map(r => r[0]).filter(Boolean).sort();
            }

            const idx = allBranches.indexOf(currentEditingBranch);
            if (idx !== -1 && idx < allBranches.length - 1) {
                const nextBranch = allBranches[idx + 1];
                openBranchModal(nextBranch);
            } else {
                showToast("Reached end of your branch list", "alert");
                closeBranchModal();
            }
        }

        // Debounced search for better performance during rapid typing
        const debouncedSearch = debounce((query) => {
            _handleSearchInternal(query);
        }, 150);

        function handleSearch(query) {
            // For very short queries, respond immediately to clear results
            if (!query || query.length < 2) {
                const resultsDiv = document.getElementById("searchResults");
                if (resultsDiv) resultsDiv.classList.remove("visible");
                return;
            }
            debouncedSearch(query);
        }

        // Internal search function (called via debounce)
        function _handleSearchInternal(query) {
            const resultsDiv = document.getElementById("searchResults");
            if (!resultsDiv || !query || query.length < 2) {
                if (resultsDiv) resultsDiv.classList.remove("visible");
                return;
            }

            const searchLower = query.toLowerCase();
            const branches = state.rawData.rows
                .map(r => ({ name: r[0], district: r[1] }))
                .filter(b => b.name && b.name.toLowerCase().includes(searchLower))
                .slice(0, 10);

            if (branches.length === 0) {
                resultsDiv.classList.remove("visible");
                return;
            }

            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            branches.forEach(match => {
                const branchEntry = state.branchDetails[match.name];
                const hasTarget = branchEntry && branchEntry.target;
                const hasAchieve = branchEntry && branchEntry.achievement;

                const item = document.createElement("div");
                item.className = "search-item";

                let statusIcon = '';
                if (hasTarget && hasAchieve) {
                    statusIcon = '<svg class="icon" style="width:14px;height:14px;color:var(--success);" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                } else if (hasTarget) {
                    statusIcon = '<svg class="icon" style="width:14px;height:14px;color:var(--warning);" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle></svg>';
                }

                item.innerHTML = `
                    <div>
                        <div style="font-weight:600">${match.name}</div>
                        <div style="font-size:11px; color:var(--text-secondary);">${match.district || ''}</div>
                    </div>
                    ${statusIcon}
                `;
                item.onclick = () => {
                    openBranchModal(match.name);
                    resultsDiv.classList.remove("visible");
                    const searchInput = document.querySelector(".search-input");
                    if (searchInput) searchInput.value = "";
                };
                fragment.appendChild(item);
            });

            resultsDiv.innerHTML = "";
            resultsDiv.appendChild(fragment);
            resultsDiv.classList.add("visible");
        }

        // Close search when clicking outside
        document.addEventListener('click', (e) => {
            const searchContainer = document.querySelector('.search-container');
            if (searchContainer && !searchContainer.contains(e.target)) {
                document.getElementById("searchResults").classList.remove("visible");
            }
        });


        function renderLineChart(data, container) {
            const width = 400;
            const height = 200;
            const padding = 20;

            const keys = Object.keys(data);
            const values = Object.values(data);
            const max = Math.max(...values, 1);

            // Generate Points
            const points = values.map((val, idx) => {
                const x = (idx / (values.length - 1)) * (width - 2 * padding) + padding;
                const y = height - ((val / max) * (height - 2 * padding)) - padding;
                return `${x},${y}`;
            }).join(" ");

            // SVG
            container.innerHTML = `
                <svg width="100%" height="100%" viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
                    <!-- Grid Lines -->
                    <line x1="${padding}" y1="${height - padding}" x2="${width - padding}" y2="${height - padding}" stroke="var(--border-color)" stroke-width="1" />
                    <line x1="${padding}" y1="${padding}" x2="${padding}" y2="${height - padding}" stroke="var(--border-color)" stroke-width="1" />
                    
                    <!-- Path -->
                    <polyline points="${points}" fill="none" stroke="var(--primary-accent)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
                    
                    <!-- Points -->
                    ${values.map((val, idx) => {
                const x = (idx / (values.length - 1)) * (width - 2 * padding) + padding;
                const y = height - ((val / max) * (height - 2 * padding)) - padding;
                return `<circle cx="${x}" cy="${y}" r="4" fill="var(--bg-card)" stroke="var(--primary-accent)" stroke-width="2" />`;
            }).join('')}
                </svg>
                <div style="display:flex; justify-content:space-between; width:100%; margin-top:10px; font-size:10px; color:var(--text-secondary);">
                    ${keys.map(k => `<span>${k.substring(0, 3)}</span>`).join('')}
                </div>
            `;
            container.style.flexDirection = "column";
        }

        function renderDonutChart(data, container) {
            const total = Object.values(data).reduce((a, b) => a + b, 0) || 1;
            let currentAngle = 0;
            const colors = ['#6366F1', '#10B981', '#F59E0B']; // Primary, Success, Warning

            // SVG Slices
            const slices = Object.entries(data).map(([key, val], idx) => {
                const pct = val / total;
                const angle = pct * 360;

                return `${colors[idx]} ${currentAngle}deg ${(currentAngle += angle)}deg`;
            });

            const gradient = `conic-gradient(${slices.join(', ')})`;

            container.innerHTML = `
               <div style="position:relative; width:180px; height:180px; border-radius:50%; background:${gradient}; display:flex; align-items:center; justify-content:center;">
                   <div style="width:120px; height:120px; background:var(--bg-card); border-radius:50%; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:10;">
                       <span style="font-size:12px; color:var(--text-secondary);">Total</span>
                       <span style="font-size:16px; font-weight:700;">â‚¹${(total / 100000).toFixed(1)}L</span>
                   </div>
               </div>
               <div style="margin-left:20px; display:flex; flex-direction:column; gap:8px;">
                   ${Object.entries(data).map(([k, v], i) => `
                        <div style="display:flex; align-items:center; gap:8px; font-size:12px;">
                            <span style="width:10px; height:10px; background:${colors[i]}; border-radius:2px;"></span>
                            <span style="color:var(--text-secondary);">${k}</span>
                            <span style="font-weight:600;">${Math.round((v / total) * 100)}%</span>
                        </div>
                   `).join('')}
               </div>
            `;
            container.style.flexDirection = "row";
        }

        function renderBarChart(data, container) {
            const max = Math.max(...Object.values(data), 1);
            Object.keys(data).forEach(label => {
                const val = data[label];
                const pct = (val / max) * 100;
                container.innerHTML += `
                    <div class="bar-group">
                        <div class="bar" style="height:${pct}%"></div>
                        <div class="bar-label">${label.substring(0, 3)}</div>
                    </div>`;
            });
        }

        // ============ NEW CEO DASHBOARD HELPER FUNCTIONS ============

        function renderCollectionMetric(label, target, achieve) {
            const pct = target > 0 ? Math.round((achieve / target) * 100) : 0;
            const progressWidth = Math.min(pct, 100);

            let color = '#10B981'; // Green
            if (pct < 100) color = '#F59E0B'; // Yellow
            if (pct < 50) color = '#EF4444'; // Red

            return `
                <div style="background:var(--bg-body); padding:20px; border-radius:12px;">
                    <div style="font-size:12px; color:var(--text-secondary); font-weight:600; margin-bottom:12px;">${label}</div>
                    <div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:8px;">
                        <span style="font-size:24px; font-weight:700; color:var(--text-primary);">${achieve.toLocaleString()}</span>
                        <span style="font-size:12px; color:var(--text-secondary);">/ ${target.toLocaleString()}</span>
                    </div>
                    <div style="height:8px; background:var(--border-color); border-radius:4px; overflow:hidden;">
                        <div style="height:100%; width:${progressWidth}%; background:${color}; border-radius:4px; transition:width 0.5s ease;"></div>
                    </div>
                    <div style="text-align:right; margin-top:6px;">
                        <span style="font-size:13px; font-weight:700; color:${color};">${pct}%</span>
                    </div>
                </div>
            `;
        }

        function renderNPAMovement(activation, closure) {
            const net = activation - closure;
            const isPositive = net > 0;
            const color = isPositive ? '#EF4444' : '#10B981'; // Red for increase, Green for decrease

            return `
                <div style="background:var(--bg-body); padding:20px; border-radius:12px;">
                    <div style="font-size:12px; color:var(--text-secondary); font-weight:600; margin-bottom:12px;">NPA Movement</div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                        <div style="text-align:center;">
                            <div style="font-size:18px; font-weight:700; color:#EF4444;">${activation}</div>
                            <div style="font-size:10px; color:var(--text-secondary);">Activated</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:18px; font-weight:700; color:#10B981;">${closure}</div>
                            <div style="font-size:10px; color:var(--text-secondary);">Closed</div>
                        </div>
                    </div>
                    <div style="background:${color}15; padding:8px; border-radius:8px; text-align:center;">
                        <span style="font-size:14px; font-weight:700; color:${color};">
                            ${isPositive ? 'â†‘' : 'â†“'} Net: ${Math.abs(net)}
                        </span>
                    </div>
                </div>
            `;
        }

        function renderPortfolioDonut(data, container) {
            if (!container) return;

            const total = (data.healthy || 0) + (data.slipped || 0) + (data.npa || 0);
            if (total === 0) {
                container.innerHTML = '<div style="color:var(--text-secondary); text-align:center;">No data available</div>';
                return;
            }

            const colors = { healthy: '#10B981', slipped: '#F59E0B', npa: '#EF4444' };
            const labels = { healthy: 'Healthy', slipped: 'Slipped', npa: 'NPA' };

            let currentAngle = 0;
            const slices = Object.entries(data).map(([key, val]) => {
                const pct = val / total;
                const angle = pct * 360;
                const result = `${colors[key]} ${currentAngle}deg ${currentAngle + angle}deg`;
                currentAngle += angle;
                return result;
            });

            const gradient = `conic-gradient(${slices.join(', ')})`;

            container.innerHTML = `
               <div style="position:relative; width:160px; height:160px; border-radius:50%; background:${gradient}; display:flex; align-items:center; justify-content:center;">
                   <div style="width:100px; height:100px; background:var(--bg-card); border-radius:50%; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:10;">
                       <span style="font-size:11px; color:var(--text-secondary);">Total</span>
                       <span style="font-size:18px; font-weight:700;">${total.toLocaleString()}</span>
                   </div>
               </div>
               <div style="margin-left:24px; display:flex; flex-direction:column; gap:12px;">
                   ${Object.entries(data).map(([k, v]) => `
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="width:12px; height:12px; background:${colors[k]}; border-radius:3px;"></span>
                            <div>
                                <div style="font-size:11px; color:var(--text-secondary);">${labels[k]}</div>
                                <div style="font-size:16px; font-weight:700; color:var(--text-primary);">${v.toLocaleString()}</div>
                            </div>
                            <span style="font-size:12px; font-weight:600; color:${colors[k]}; margin-left:auto;">${Math.round((v / total) * 100)}%</span>
                        </div>
                   `).join('')}
               </div>
            `;
            container.style.flexDirection = "row";
        }

        function renderRegionalTable(data, tbody) {
            if (!tbody || !data) return;

            Object.keys(data).sort().forEach(region => {
                const r = data[region];
                const completionPct = r.branches > 0 ? Math.round((r.completed / r.branches) * 100) : 0;

                let statusColor = '#10B981';
                let statusText = 'On Track';
                if (completionPct < 80) { statusColor = '#F59E0B'; statusText = 'In Progress'; }
                if (completionPct < 50) { statusColor = '#EF4444'; statusText = 'Needs Attention'; }

                let achieveColor = '#10B981';
                if (r.avgPct < 100) achieveColor = '#F59E0B';
                if (r.avgPct < 50) achieveColor = '#EF4444';

                tbody.innerHTML += `
                    <tr class="clickable-row" onclick="openDetailModal('region', '${region}')" style="cursor:pointer;">
                        <td><span style="font-weight:600;">${region}</span> <span style="font-size:10px; color:var(--text-secondary);">â†’ Click to view</span></td>
                        <td>${r.branches}</td>
                        <td>${r.completed} <span style="color:var(--text-secondary);">(${completionPct}%)</span></td>
                        <td>
                            <span style="background:${achieveColor}20; color:${achieveColor}; padding:4px 12px; border-radius:20px; font-weight:600; font-size:12px;">
                                ${r.avgPct}%
                            </span>
                        </td>
                        <td><span class="status-pill" style="background:${statusColor}20; color:${statusColor};">${statusText}</span></td>
                    </tr>`;
            });
        }

        function renderLeaderboard(data, tbody) {
            const sorted = Object.entries(data).sort((a, b) => b[1] - a[1]).slice(0, 5);
            sorted.forEach((item, idx) => {
                tbody.innerHTML += `
                    <tr>
                        <td>#${idx + 1}</td>
                        <td><span style="font-weight:600">${item[0]}</span></td>
                        <td>${item[1].toLocaleString()}</td>
                        <td><span class="status-pill status-active">Top Tier</span></td>
                    </tr>`;
            });
        }

        function renderDMTable(tbody) {
            const idxDM = state.rawData.headers.findIndex(h => h.trim().toLowerCase() === "dm name");
            const idxBranch = state.rawData.headers.findIndex(h => h.trim().toLowerCase() === "branch");
            const idxDistrict = state.rawData.headers.findIndex(h => h.trim().toLowerCase() === "district");

            const rows = state.rawData.rows.filter(r => (r[idxDM] || "").trim() === state.currentUser);

            rows.forEach(row => {
                const branch = row[idxBranch];
                const district = row[idxDistrict];
                const val = state.targetData[branch] || 0;

                tbody.innerHTML += `
                <tr>
                    <td>${district}</td>
                    <td>${branch}</td>
                    <td>
                        <input type="number" data-branch="${branch}" value="${val}" style="padding:8px; border:1px solid #ddd; border-radius:6px; width:100px;">
                    </td>
                    <td><span class="status-pill status-pending">Pending</span></td>
                </tr>`;
            });
        }

        function buildHierarchy(headers, rows) {
            const tree = {};
            rows.forEach(r => {
                const [branch, dist, dm, region] = r;
                if (!region) return;
                if (!tree[region]) tree[region] = {};
                if (!tree[region][dm]) tree[region][dm] = {};
                if (!tree[region][dm][dist]) tree[region][dm][dist] = new Set();
                tree[region][dm][dist].add(branch);
            });
            return tree;
        }

        function calculateTotal(type, name, children) {
            if (children instanceof Set) {
                let sum = 0;
                children.forEach(branch => sum += (state.targetData[branch] || 0));
                return sum;
            }
            let sum = 0;
            Object.keys(children).forEach(k => sum += calculateTotal(getNextType(type), k, children[k]));
            return sum;
        }

        // Calculate average percentage for a single branch based on all metrics
        function calculateBranchAveragePercentage(branchName) {
            const branchEntry = state.branchDetails[branchName];
            if (!branchEntry || !branchEntry.target || !branchEntry.achievement) {
                return null; // No data available
            }

            const targetData = branchEntry.target;
            const achieveData = branchEntry.achievement;

            // All fields that have target/achievement pairs
            const fields = [
                'ftod_actual', 'ftod_plan', 'lived_actual', 'lived_plan',
                'pnpa_actual', 'pnpa_plan', 'npa_activation', 'npa_closure',
                'fy_od_acc', 'fy_od_plan', 'fy_non_start_acc', 'fy_non_start_plan',
                'disb_sanc_pent_acc', 'disb_sanc_pent_amt', 'disb_igl_acc', 'disb_igl_amt',
                'disb_il_acc', 'disb_il_amt', 'kyc_fig_igl', 'kyc_il', 'kyc_npa'
            ];

            let validPercentages = [];

            fields.forEach(field => {
                const target = Number(targetData[field]) || 0;
                const achieve = Number(achieveData[field]) || 0;

                if (target > 0) {
                    const pct = (achieve / target) * 100;
                    validPercentages.push(pct);
                }
            });

            if (validPercentages.length === 0) return 0;

            const avgPct = validPercentages.reduce((sum, p) => sum + p, 0) / validPercentages.length;
            return Math.round(avgPct);
        }

        // Calculate average percentage for hierarchy nodes (aggregated from children)
        function calculateAveragePercentage(type, name, children) {
            if (children instanceof Set) {
                // Leaf level - aggregate all branch percentages
                let validBranches = [];
                children.forEach(branch => {
                    const pct = calculateBranchAveragePercentage(branch);
                    if (pct !== null) {
                        validBranches.push(pct);
                    }
                });

                if (validBranches.length === 0) return null;
                return Math.round(validBranches.reduce((sum, p) => sum + p, 0) / validBranches.length);
            }

            // Non-leaf - aggregate from children
            let validChildren = [];
            Object.keys(children).forEach(k => {
                const pct = calculateAveragePercentage(getNextType(type), k, children[k]);
                if (pct !== null) {
                    validChildren.push(pct);
                }
            });

            if (validChildren.length === 0) return null;
            return Math.round(validChildren.reduce((sum, p) => sum + p, 0) / validChildren.length);
        }

        function getNextType(t) { return t === "Region" ? "DM" : t === "DM" ? "District" : "Branch"; }

        function parseTSV(text) {
            const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);
            const rows = lines.slice(1).map(line => line.split("\t").map(c => c.trim()));
            return { headers: lines[0].split("\t"), rows };
        }

        function populateDMDropdown(rows, headers) {
            const dms = new Set(rows.map(r => r[2]).filter(Boolean));
            const sel = document.getElementById("dmSelect");
            Array.from(dms).sort().forEach(dm => {
                const opt = document.createElement("option");
                opt.value = dm; opt.textContent = dm;
                sel.appendChild(opt);
            });
        }

        function getDMNode() {
            // Find the node for the current logged in DM
            if (!state.currentUser) return null;
            for (const region in state.fullTree) {
                if (state.fullTree[region][state.currentUser]) {
                    return state.fullTree[region][state.currentUser];
                }
            }
            return null;
        }

        function saveTargets() {
            const inputs = document.querySelectorAll("input[data-branch]");
            inputs.forEach(i => {
                state.targetData[i.dataset.branch] = parseInt(i.value) || 0;
            });
            localStorage.setItem('dosa_targets', JSON.stringify(state.targetData));
            showToast("Targets Saved Successfully!", "check");
        }

        function calculateCEOStats() {
            let totalBranches = 0;
            let completedBranches = 0;
            let pendingAchievement = 0;
            let noDataBranches = 0;

            // Collection Metrics
            let ftodTarget = 0, ftodAchieve = 0;
            let livedTarget = 0, livedAchieve = 0;
            let pnpaTarget = 0, pnpaAchieve = 0;
            let npaActivation = 0, npaClosure = 0;

            // Disbursement
            let disbSancAcc = 0, disbSancAmt = 0;
            let disbIglAcc = 0, disbIglAmt = 0;
            let disbIlAcc = 0, disbIlAmt = 0;

            // KYC
            let kycFigIgl = 0, kycIl = 0, kycNpa = 0;

            // Portfolio Health
            let portfolioHealth = { healthy: 0, slipped: 0, npa: 0 };

            // Regional breakdown
            let regionStats = {};
            let regionalBreakdown = {};

            // Achievement percentages
            let allAchievementPcts = [];

            const safeInt = (v) => parseInt(v) || 0;

            state.rawData.rows.forEach(row => {
                const branch = row[0];
                const region = row[3];

                if (branch) {
                    totalBranches++;

                    // Initialize region
                    if (!regionStats[region]) regionStats[region] = { branches: 0, completed: 0, totalPct: 0, count: 0 };
                    regionStats[region].branches++;

                    const branchEntry = state.branchDetails[branch];
                    const hasTarget = branchEntry && branchEntry.target;
                    const hasAchieve = branchEntry && branchEntry.achievement;

                    if (hasTarget && hasAchieve) {
                        completedBranches++;
                        regionStats[region].completed++;

                        const t = branchEntry.target;
                        const a = branchEntry.achievement;

                        // Collection
                        ftodTarget += safeInt(t.ftod_plan);
                        ftodAchieve += safeInt(a.ftod_actual);
                        livedTarget += safeInt(t.lived_plan);
                        livedAchieve += safeInt(a.lived_actual);
                        pnpaTarget += safeInt(t.pnpa_plan);
                        pnpaAchieve += safeInt(a.pnpa_actual);
                        npaActivation += safeInt(a.npa_activation);
                        npaClosure += safeInt(a.npa_closure);

                        // Disbursement
                        disbSancAcc += safeInt(a.disb_sanc_pent_acc);
                        disbSancAmt += safeInt(a.disb_sanc_pent_amt);
                        disbIglAcc += safeInt(a.disb_igl_acc);
                        disbIglAmt += safeInt(a.disb_igl_amt);
                        disbIlAcc += safeInt(a.disb_il_acc);
                        disbIlAmt += safeInt(a.disb_il_amt);

                        // KYC
                        kycFigIgl += safeInt(a.kyc_fig_igl);
                        kycIl += safeInt(a.kyc_il);
                        kycNpa += safeInt(a.kyc_npa);

                        // Portfolio Health
                        portfolioHealth.healthy += safeInt(a.ftod_actual);
                        portfolioHealth.slipped += safeInt(a.lived_actual);
                        portfolioHealth.npa += safeInt(a.pnpa_actual);

                        // Calculate branch average achievement %
                        const branchPct = calculateBranchAveragePercentage(branch);
                        if (branchPct !== null && branchPct > 0) {
                            allAchievementPcts.push(branchPct);
                            regionStats[region].totalPct += branchPct;
                            regionStats[region].count++;
                        }
                    } else if (hasTarget && !hasAchieve) {
                        pendingAchievement++;
                    } else {
                        noDataBranches++;
                    }
                }
            });

            // Build regional breakdown for table
            Object.keys(regionStats).sort().forEach(region => {
                const r = regionStats[region];
                regionalBreakdown[region] = {
                    branches: r.branches,
                    completed: r.completed,
                    avgPct: r.count > 0 ? Math.round(r.totalPct / r.count) : 0
                };
            });

            // Calculate overall averages
            const completionRate = totalBranches > 0 ? Math.round((completedBranches / totalBranches) * 100) : 0;
            const avgAchievementPct = allAchievementPcts.length > 0
                ? Math.round(allAchievementPcts.reduce((a, b) => a + b, 0) / allAchievementPcts.length)
                : 0;

            const totalCollectionTarget = ftodTarget + livedTarget + pnpaTarget;
            const totalDisbursement = disbSancAmt + disbIglAmt + disbIlAmt;
            const kycTotal = kycFigIgl + kycIl + kycNpa;

            return {
                totalBranches,
                completedBranches,
                pendingAchievement,
                noDataBranches,
                completionRate,
                avgAchievementPct,
                totalCollectionTarget,

                // Collection
                ftodTarget, ftodAchieve,
                livedTarget, livedAchieve,
                pnpaTarget, pnpaAchieve,
                npaActivation, npaClosure,

                // Disbursement
                totalDisbursement,
                disbSancAcc, disbSancAmt,
                disbIglAcc, disbIglAmt,
                disbIlAcc, disbIlAmt,

                // KYC
                kycFigIgl, kycIl, kycNpa, kycTotal,

                // Portfolio
                portfolioHealth,

                // Regional
                regionStats,
                regionalBreakdown
            };
        }

        // ============ CEO DETAIL MODAL FUNCTIONS ============

        // Add Escape key listener for closing detail modal
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                const detailModal = document.getElementById('detailModal');
                if (detailModal && detailModal.classList.contains('visible')) {
                    closeDetailModal();
                }
            }
        });

        function openDetailModal(type, data = null) {
            const modal = document.getElementById('detailModal');
            const body = document.getElementById('detailModalBody');
            const titleText = document.getElementById('detailTitleText');
            const titleIcon = document.getElementById('detailTitleIcon');
            const subtitle = document.getElementById('detailSubtitle');

            // Set title based on type
            const config = {
                'completion': { icon: 'âœ…', title: 'Completion Rate Analysis', subtitle: 'Branch-wise completion status' },
                'branches': { icon: 'ðŸ¢', title: 'Active Branches', subtitle: 'All branches by region' },
                'achievement': { icon: 'ðŸ“ˆ', title: 'Achievement Analysis', subtitle: 'Performance ranking' },
                'collection': { icon: 'ðŸ’°', title: 'Collection Target Breakdown', subtitle: 'FTOD + Slipped + PNPA' },
                'ftod': { icon: 'ðŸŽ¯', title: 'FTOD Collection Details', subtitle: 'First Time Overdue' },
                'slipped': { icon: 'âš ï¸', title: 'Slipped Account Details', subtitle: 'Lived/Slipped accounts' },
                'pnpa': { icon: 'ðŸ“Š', title: 'PNPA Details', subtitle: 'Potential NPA accounts' },
                'npa': { icon: 'ðŸ”´', title: 'NPA Movement Details', subtitle: 'Activation vs Closure' },
                'portfolio': { icon: 'ðŸ“‰', title: 'Portfolio Health Details', subtitle: 'Account distribution' },
                'disbursement': { icon: 'ðŸ’³', title: 'Disbursement Details', subtitle: 'Product-wise breakdown' },
                'disb_sanction': { icon: 'ðŸ“', title: 'Sanction Pending Details', subtitle: 'Pending approvals' },
                'disb_igl': { icon: 'ðŸŒ±', title: 'IGL & FIG Details', subtitle: 'Individual/Group loans' },
                'disb_il': { icon: 'ðŸ ', title: 'IL Details', subtitle: 'Individual loans' },
                'region': { icon: 'ðŸŒ', title: `Region: ${data || 'All'}`, subtitle: 'Regional performance' },
                'pending': { icon: 'â³', title: 'Pending Achievement', subtitle: 'Branches with only targets' },
                'nodata': { icon: 'âŒ', title: 'No Data Branches', subtitle: 'Branches without reports' },
                'completed': { icon: 'âœ“', title: 'Fully Completed', subtitle: 'Branches with full data' },
                'kyc': { icon: 'ðŸ“‹', title: 'KYC Sourcing Details', subtitle: 'Customer acquisition' }
            };

            const cfg = config[type] || { icon: 'ðŸ“Š', title: 'Details', subtitle: '' };
            titleIcon.textContent = cfg.icon;
            titleText.textContent = cfg.title;
            subtitle.textContent = cfg.subtitle;

            // Render content based on type
            body.innerHTML = renderDetailContent(type, data);

            // Show modal
            modal.classList.add('visible');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('visible');
        }

        // Helper function to open branch modal from detail view
        // Closes detail modal first so branch modal appears on top
        function openBranchFromDetail(branchName) {
            closeDetailModal();
            // Small delay to ensure detail modal is closed before opening branch modal
            setTimeout(() => {
                openBranchModal(branchName);
            }, 150);
        }

        function renderDetailContent(type, data) {
            const stats = calculateCEOStats();

            switch (type) {
                case 'completion': return renderCompletionDetail(stats);
                case 'branches': return renderBranchesDetail(stats);
                case 'achievement': return renderAchievementDetail(stats);
                case 'collection': return renderCollectionDetail(stats);
                case 'ftod': return renderMetricDetail('ftod', stats);
                case 'slipped': return renderMetricDetail('slipped', stats);
                case 'pnpa': return renderMetricDetail('pnpa', stats);
                case 'npa': return renderMetricDetail('npa', stats);
                case 'portfolio': return renderPortfolioDetailView(data, stats);
                case 'disbursement': return renderDisbursementDetailView(stats);
                case 'disb_sanction': return renderDisbProductDetail('sanction', stats);
                case 'disb_igl': return renderDisbProductDetail('igl', stats);
                case 'disb_il': return renderDisbProductDetail('il', stats);
                case 'region': return renderRegionDetailView(data, stats);
                case 'pending': return renderInsightDetail('pending', stats);
                case 'nodata': return renderInsightDetail('nodata', stats);
                case 'completed': return renderInsightDetail('completed', stats);
                case 'kyc': return renderKYCDetail(stats);
                default: return '<p>No data available</p>';
            }
        }

        // --- Completion Rate Detail ---
        function renderCompletionDetail(stats) {
            const branches = getBranchListByStatus();

            return `
                <div class="detail-summary-row">
                    <div class="detail-stat-card">
                        <div class="detail-stat-value" style="color:#10B981;">${stats.completedBranches}</div>
                        <div class="detail-stat-label">Completed</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-value" style="color:#F59E0B;">${stats.pendingAchievement}</div>
                        <div class="detail-stat-label">Pending Achievement</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-value" style="color:#EF4444;">${stats.noDataBranches}</div>
                        <div class="detail-stat-label">No Data</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-value" style="color:var(--primary-accent);">${stats.completionRate}%</div>
                        <div class="detail-stat-label">Overall Rate</div>
                    </div>
                </div>
                
                <div class="detail-filter-bar">
                    <button class="detail-filter-btn active" onclick="filterBranchList('all')">All (${stats.totalBranches})</button>
                    <button class="detail-filter-btn" onclick="filterBranchList('completed')">âœ… Completed (${stats.completedBranches})</button>
                    <button class="detail-filter-btn" onclick="filterBranchList('pending')">â³ Pending (${stats.pendingAchievement})</button>
                    <button class="detail-filter-btn" onclick="filterBranchList('nodata')">âŒ No Data (${stats.noDataBranches})</button>
                </div>
                
                <div class="detail-branch-list" id="branchListContainer">
                    <div class="detail-branch-header">
                        <div>Branch</div>
                        <div>Region</div>
                        <div>DM</div>
                        <div>Status</div>
                        <div>Achievement %</div>
                        <div>Action</div>
                    </div>
                    ${branches.map(b => `
                        <div class="detail-branch-row" data-status="${b.status}">
                            <div>
                                <div class="detail-branch-name">${b.name}</div>
                                <div class="detail-branch-region">${b.district}</div>
                            </div>
                            <div>${b.region}</div>
                            <div>${b.dm}</div>
                            <div>
                                <span class="detail-pct-badge" style="background:${b.statusColor}20; color:${b.statusColor};">
                                    ${b.statusLabel}
                                </span>
                            </div>
                            <div>
                                <span class="detail-pct-badge" style="background:${b.pctColor}20; color:${b.pctColor};">
                                    ${b.pct}
                                </span>
                            </div>
                            <div>
                                <button onclick="openBranchFromDetail('${b.name}')" style="padding:6px 12px; border-radius:6px; border:1px solid var(--border-color); background:var(--bg-card); cursor:pointer; font-size:11px;">
                                    View
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // --- Branches by Region Detail ---
        function renderBranchesDetail(stats) {
            const regionData = getRegionBreakdown();

            return `
                <div class="detail-summary-row">
                    <div class="detail-stat-card">
                        <div class="detail-stat-value">${stats.totalBranches}</div>
                        <div class="detail-stat-label">Total Branches</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-value">${Object.keys(stats.regionStats).length}</div>
                        <div class="detail-stat-label">Regions</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-value">${getUniqueDMs()}</div>
                        <div class="detail-stat-label">District Managers</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-value">${getUniqueDistricts()}</div>
                        <div class="detail-stat-label">Districts</div>
                    </div>
                </div>
                
                <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:20px;">
                    ${Object.keys(regionData).sort().map(region => `
                        <div class="detail-stat-card clickable-section" onclick="openDetailModal('region', '${region}')" style="text-align:left; cursor:pointer;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                <div style="font-size:16px; font-weight:700; color:var(--text-primary);">ðŸŒ ${region}</div>
                                <span style="font-size:12px; color:var(--text-secondary);">${regionData[region].branches} branches</span>
                            </div>
                            <div style="height:6px; background:var(--border-color); border-radius:3px; overflow:hidden;">
                                <div style="height:100%; width:${regionData[region].completionPct}%; background:var(--primary-accent);"></div>
                            </div>
                            <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:11px; color:var(--text-secondary);">
                                <span>${regionData[region].completed} completed</span>
                                <span style="font-weight:600; color:var(--primary-accent);">${regionData[region].completionPct}%</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // --- Achievement Ranking Detail ---
        function renderAchievementDetail(stats) {
            const rankedBranches = getRankedBranches();

            return `
                <div class="detail-summary-row">
                    <div class="detail-stat-card">
                        <div class="detail-stat-value" style="color:#10B981;">${stats.avgAchievementPct}%</div>
                        <div class="detail-stat-label">Average Achievement</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-value" style="color:#10B981;">${rankedBranches.filter(b => b.pct >= 100).length}</div>
                        <div class="detail-stat-label">Above 100%</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-value" style="color:#F59E0B;">${rankedBranches.filter(b => b.pct >= 50 && b.pct < 100).length}</div>
                        <div class="detail-stat-label">50-99%</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-value" style="color:#EF4444;">${rankedBranches.filter(b => b.pct > 0 && b.pct < 50).length}</div>
                        <div class="detail-stat-label">Below 50%</div>
                    </div>
                </div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:24px;">
                    <div class="detail-branch-list">
                        <div style="padding:16px 24px; background:linear-gradient(135deg, #10B981 0%, #059669 100%); color:white; font-weight:700;">
                            ðŸ† Top 10 Performers
                        </div>
                        ${rankedBranches.slice(0, 10).map((b, i) => `
                            <div class="detail-branch-row" style="grid-template-columns: 40px 2fr 1fr;">
                                <div style="font-size:18px; font-weight:700; color:${i < 3 ? '#F59E0B' : 'var(--text-secondary)'};">#${i + 1}</div>
                                <div>
                                    <div class="detail-branch-name">${b.name}</div>
                                    <div class="detail-branch-region">${b.region}</div>
                                </div>
                                <div>
                                    <span class="detail-pct-badge" style="background:#10B98120; color:#10B981;">${b.pct}%</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="detail-branch-list">
                        <div style="padding:16px 24px; background:linear-gradient(135deg, #EF4444 0%, #DC2626 100%); color:white; font-weight:700;">
                            âš ï¸ Bottom 10 - Need Attention
                        </div>
                        ${rankedBranches.slice(-10).reverse().map((b, i) => `
                            <div class="detail-branch-row" style="grid-template-columns: 40px 2fr 1fr;">
                                <div style="font-size:14px; color:#EF4444;">ðŸ“‰</div>
                                <div>
                                    <div class="detail-branch-name">${b.name}</div>
                                    <div class="detail-branch-region">${b.region}</div>
                                </div>
                                <div>
                                    <span class="detail-pct-badge" style="background:#EF444420; color:#EF4444;">${b.pct}%</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // --- Collection Target Detail ---
        function renderCollectionDetail(stats) {
            return `
                <div class="detail-summary-row">
                    <div class="detail-stat-card clickable-section" onclick="openDetailModal('ftod')">
                        <div class="detail-stat-value" style="color:#6366F1;">â‚¹${(stats.ftodTarget / 100000).toFixed(1)}L</div>
                        <div class="detail-stat-label">FTOD Target</div>
                        <div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">Click for details â†’</div>
                    </div>
                    <div class="detail-stat-card clickable-section" onclick="openDetailModal('slipped')">
                        <div class="detail-stat-value" style="color:#F59E0B;">â‚¹${(stats.livedTarget / 100000).toFixed(1)}L</div>
                        <div class="detail-stat-label">Slipped Target</div>
                        <div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">Click for details â†’</div>
                    </div>
                    <div class="detail-stat-card clickable-section" onclick="openDetailModal('pnpa')">
                        <div class="detail-stat-value" style="color:#EF4444;">â‚¹${(stats.pnpaTarget / 100000).toFixed(1)}L</div>
                        <div class="detail-stat-label">PNPA Target</div>
                        <div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">Click for details â†’</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-value" style="color:var(--primary-accent);">â‚¹${(stats.totalCollectionTarget / 100000).toFixed(1)}L</div>
                        <div class="detail-stat-label">Total Target</div>
                    </div>
                </div>
                
                ${renderMetricBranchTable('collection', stats)}
            `;
        }

        // --- Single Metric Detail (FTOD, Slipped, PNPA, NPA) ---
        function renderMetricDetail(metricType, stats) {
            const config = {
                'ftod': { label: 'FTOD', targetField: 'ftod_plan', achieveField: 'ftod_actual', target: stats.ftodTarget, achieve: stats.ftodAchieve },
                'slipped': { label: 'Slipped', targetField: 'lived_plan', achieveField: 'lived_actual', target: stats.livedTarget, achieve: stats.livedAchieve },
                'pnpa': { label: 'PNPA', targetField: 'pnpa_plan', achieveField: 'pnpa_actual', target: stats.pnpaTarget, achieve: stats.pnpaAchieve },
                'npa': { label: 'NPA Movement', targetField: null, achieveField: null, activation: stats.npaActivation, closure: stats.npaClosure }
            };

            const cfg = config[metricType];

            if (metricType === 'npa') {
                return renderNPADetail(stats);
            }

            const pct = cfg.target > 0 ? Math.round((cfg.achieve / cfg.target) * 100) : 0;
            const pctColor = pct >= 100 ? '#10B981' : pct >= 50 ? '#F59E0B' : '#EF4444';

            return `
                <div class="detail-summary-row">
                    <div class="detail-stat-card">
                        <div class="detail-stat-value">${cfg.target.toLocaleString()}</div>
                        <div class="detail-stat-label">Total Target</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-value" style="color:${pctColor};">${cfg.achieve.toLocaleString()}</div>
                        <div class="detail-stat-label">Total Achievement</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-value" style="color:${pctColor};">${pct}%</div>
                        <div class="detail-stat-label">Achievement Rate</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-value" style="color:${cfg.target - cfg.achieve > 0 ? '#EF4444' : '#10B981'};">${Math.abs(cfg.target - cfg.achieve).toLocaleString()}</div>
                        <div class="detail-stat-label">${cfg.target - cfg.achieve > 0 ? 'Gap' : 'Surplus'}</div>
                    </div>
                </div>
                
                ${renderMetricBranchTable(metricType, stats)}
            `;
        }

        // --- NPA Detail ---
        function renderNPADetail(stats) {
            const net = stats.npaActivation - stats.npaClosure;
            const netColor = net > 0 ? '#EF4444' : '#10B981';

            const branchNPA = getBranchNPAData();

            return `
                <div class="detail-summary-row">
                    <div class="detail-stat-card">
                        <div class="detail-stat-value" style="color:#EF4444;">${stats.npaActivation}</div>
                        <div class="detail-stat-label">NPA Activated</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-value" style="color:#10B981;">${stats.npaClosure}</div>
                        <div class="detail-stat-label">NPA Closed</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-value" style="color:${netColor};">${net > 0 ? '+' : ''}${net}</div>
                        <div class="detail-stat-label">Net Movement</div>
                    </div>
                    <div class="detail-stat-card">
                        <div style="font-size:40px;">${net > 0 ? 'ðŸ“ˆ' : 'ðŸ“‰'}</div>
                        <div class="detail-stat-label">${net > 0 ? 'Increasing' : 'Decreasing'}</div>
                    </div>
                </div>
                
                <div class="detail-branch-list">
                    <div class="detail-branch-header" style="grid-template-columns: 2fr 1fr 1fr 1fr 1fr;">
                        <div>Branch</div>
                        <div>Region</div>
                        <div style="color:#EF4444;">Activated</div>
                        <div style="color:#10B981;">Closed</div>
                        <div>Net</div>
                    </div>
                    ${branchNPA.map(b => `
                        <div class="detail-branch-row" style="grid-template-columns: 2fr 1fr 1fr 1fr 1fr;">
                            <div class="detail-branch-name">${b.name}</div>
                            <div>${b.region}</div>
                            <div style="font-weight:600; color:#EF4444;">${b.activation}</div>
                            <div style="font-weight:600; color:#10B981;">${b.closure}</div>
                            <div>
                                <span class="detail-pct-badge" style="background:${b.net > 0 ? '#EF4444' : '#10B981'}20; color:${b.net > 0 ? '#EF4444' : '#10B981'};">
                                    ${b.net > 0 ? '+' : ''}${b.net}
                                </span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // --- Portfolio Detail View ---
        function renderPortfolioDetailView(category, stats) {
            const portfolioData = getPortfolioBreakdown();
            const total = stats.portfolioHealth.healthy + stats.portfolioHealth.slipped + stats.portfolioHealth.npa;

            return `
                <div class="detail-summary-row">
                    <div class="detail-stat-card">
                        <div class="detail-stat-value" style="color:#10B981;">${stats.portfolioHealth.healthy}</div>
                        <div class="detail-stat-label">Healthy (FTOD)</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-value" style="color:#F59E0B;">${stats.portfolioHealth.slipped}</div>
                        <div class="detail-stat-label">Slipped</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-value" style="color:#EF4444;">${stats.portfolioHealth.npa}</div>
                        <div class="detail-stat-label">PNPA</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-value">${total}</div>
                        <div class="detail-stat-label">Total Accounts</div>
                    </div>
                </div>
                
                <div class="detail-filter-bar">
                    <button class="detail-filter-btn active" onclick="filterPortfolio('all')">All</button>
                    <button class="detail-filter-btn" onclick="filterPortfolio('healthy')" style="border-color:#10B981; color:#10B981;">Healthy</button>
                    <button class="detail-filter-btn" onclick="filterPortfolio('slipped')" style="border-color:#F59E0B; color:#F59E0B;">Slipped</button>
                    <button class="detail-filter-btn" onclick="filterPortfolio('npa')" style="border-color:#EF4444; color:#EF4444;">PNPA</button>
                </div>
                
                <div class="detail-branch-list">
                    <div class="detail-branch-header" style="grid-template-columns: 2fr 1fr 1fr 1fr 1fr;">
                        <div>Branch</div>
                        <div>Region</div>
                        <div style="color:#10B981;">Healthy</div>
                        <div style="color:#F59E0B;">Slipped</div>
                        <div style="color:#EF4444;">PNPA</div>
                    </div>
                    ${portfolioData.map(b => `
                        <div class="detail-branch-row" style="grid-template-columns: 2fr 1fr 1fr 1fr 1fr;">
                            <div class="detail-branch-name">${b.name}</div>
                            <div>${b.region}</div>
                            <div style="font-weight:600; color:#10B981;">${b.healthy}</div>
                            <div style="font-weight:600; color:#F59E0B;">${b.slipped}</div>
                            <div style="font-weight:600; color:#EF4444;">${b.pnpa}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // --- Disbursement Detail View ---
        function renderDisbursementDetailView(stats) {
            return `
                <div class="detail-summary-row">
                    <div class="detail-stat-card clickable-section" onclick="openDetailModal('disb_sanction')">
                        <div class="detail-stat-value" style="color:#6366F1;">${stats.disbSancAcc}</div>
                        <div class="detail-stat-label">Sanction Pending</div>
                        <div style="font-size:12px; color:var(--text-secondary);">â‚¹${(stats.disbSancAmt / 100000).toFixed(1)}L</div>
                    </div>
                    <div class="detail-stat-card clickable-section" onclick="openDetailModal('disb_igl')">
                        <div class="detail-stat-value" style="color:#10B981;">${stats.disbIglAcc}</div>
                        <div class="detail-stat-label">IGL & FIG</div>
                        <div style="font-size:12px; color:var(--text-secondary);">â‚¹${(stats.disbIglAmt / 100000).toFixed(1)}L</div>
                    </div>
                    <div class="detail-stat-card clickable-section" onclick="openDetailModal('disb_il')">
                        <div class="detail-stat-value" style="color:#F59E0B;">${stats.disbIlAcc}</div>
                        <div class="detail-stat-label">IL</div>
                        <div style="font-size:12px; color:var(--text-secondary);">â‚¹${(stats.disbIlAmt / 100000).toFixed(1)}L</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-value" style="color:var(--primary-accent);">â‚¹${(stats.totalDisbursement / 10000000).toFixed(2)}Cr</div>
                        <div class="detail-stat-label">Total Disbursement</div>
                    </div>
                </div>
                
                ${renderDisbursementBranchTable(stats)}
            `;
        }

        // --- Disbursement Product Detail ---
        function renderDisbProductDetail(product, stats) {
            const config = {
                'sanction': { accField: 'disb_sanc_pent_acc', amtField: 'disb_sanc_pent_amt', label: 'Sanction Pending' },
                'igl': { accField: 'disb_igl_acc', amtField: 'disb_igl_amt', label: 'IGL & FIG' },
                'il': { accField: 'disb_il_acc', amtField: 'disb_il_amt', label: 'IL' }
            };

            const cfg = config[product];
            const branchData = getDisbursementByProduct(cfg.accField, cfg.amtField);

            return `
                <div class="detail-branch-list">
                    <div class="detail-branch-header" style="grid-template-columns: 2fr 1fr 1fr 1fr;">
                        <div>Branch</div>
                        <div>Region</div>
                        <div>Accounts</div>
                        <div>Amount (â‚¹)</div>
                    </div>
                    ${branchData.map(b => `
                        <div class="detail-branch-row" style="grid-template-columns: 2fr 1fr 1fr 1fr;">
                            <div class="detail-branch-name">${b.name}</div>
                            <div>${b.region}</div>
                            <div style="font-weight:600;">${b.accounts}</div>
                            <div style="font-weight:600;">â‚¹${(b.amount / 100000).toFixed(2)}L</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // --- Region Detail View ---
        function renderRegionDetailView(regionName, stats) {
            const branches = getBranchesByRegion(regionName);
            const regionStats = stats.regionalBreakdown[regionName] || { branches: 0, completed: 0, avgPct: 0 };

            return `
                <div class="detail-summary-row">
                    <div class="detail-stat-card">
                        <div class="detail-stat-value">${regionStats.branches}</div>
                        <div class="detail-stat-label">Total Branches</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-value" style="color:#10B981;">${regionStats.completed}</div>
                        <div class="detail-stat-label">Completed</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-value" style="color:#F59E0B;">${regionStats.branches - regionStats.completed}</div>
                        <div class="detail-stat-label">Pending</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-value" style="color:var(--primary-accent);">${regionStats.avgPct}%</div>
                        <div class="detail-stat-label">Avg Achievement</div>
                    </div>
                </div>
                
                <div class="detail-branch-list">
                    <div class="detail-branch-header">
                        <div>Branch</div>
                        <div>District</div>
                        <div>DM</div>
                        <div>Status</div>
                        <div>Achievement</div>
                        <div>Action</div>
                    </div>
                    ${branches.map(b => `
                        <div class="detail-branch-row">
                            <div class="detail-branch-name">${b.name}</div>
                            <div>${b.district}</div>
                            <div>${b.dm}</div>
                            <div>
                                <span class="detail-pct-badge" style="background:${b.statusColor}20; color:${b.statusColor};">
                                    ${b.statusLabel}
                                </span>
                            </div>
                            <div>
                                <span class="detail-pct-badge" style="background:${b.pctColor}20; color:${b.pctColor};">
                                    ${b.pct}
                                </span>
                            </div>
                            <div>
                                <button onclick="openBranchFromDetail('${b.name}')" style="padding:6px 12px; border-radius:6px; border:1px solid var(--border-color); background:var(--bg-card); cursor:pointer; font-size:11px;">
                                    View
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // --- Insight Detail (Pending/NoData/Completed) ---
        function renderInsightDetail(insightType, stats) {
            const branches = getBranchListByStatus();
            let filtered = [];

            if (insightType === 'pending') {
                filtered = branches.filter(b => b.status === 'pending');
            } else if (insightType === 'nodata') {
                filtered = branches.filter(b => b.status === 'nodata');
            } else {
                filtered = branches.filter(b => b.status === 'completed');
            }

            return `
                <div style="margin-bottom:20px; font-size:14px; color:var(--text-secondary);">
                    Found <strong>${filtered.length}</strong> branches matching this criteria
                </div>
                
                <div class="detail-branch-list">
                    <div class="detail-branch-header">
                        <div>Branch</div>
                        <div>District</div>
                        <div>DM</div>
                        <div>Region</div>
                        <div>Status</div>
                        <div>Action</div>
                    </div>
                    ${filtered.map(b => `
                        <div class="detail-branch-row">
                            <div class="detail-branch-name">${b.name}</div>
                            <div>${b.district}</div>
                            <div>${b.dm}</div>
                            <div>${b.region}</div>
                            <div>
                                <span class="detail-pct-badge" style="background:${b.statusColor}20; color:${b.statusColor};">
                                    ${b.statusLabel}
                                </span>
                            </div>
                            <div>
                                <button onclick="openBranchFromDetail('${b.name}')" style="padding:6px 12px; border-radius:6px; border:1px solid var(--border-color); background:var(--bg-card); cursor:pointer; font-size:11px;">
                                    ${insightType === 'completed' ? 'View' : 'Enter Data'}
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // --- KYC Detail ---
        function renderKYCDetail(stats) {
            const kycData = getKYCBreakdown();

            return `
                <div class="detail-summary-row">
                    <div class="detail-stat-card">
                        <div class="detail-stat-value" style="color:#6366F1;">${stats.kycFigIgl}</div>
                        <div class="detail-stat-label">FIG & IGL</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-value" style="color:#F59E0B;">${stats.kycIl}</div>
                        <div class="detail-stat-label">IL</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-value" style="color:#10B981;">${stats.kycNpa}</div>
                        <div class="detail-stat-label">NPA</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-value">${stats.kycTotal}</div>
                        <div class="detail-stat-label">Total KYC</div>
                    </div>
                </div>
                
                <div class="detail-branch-list">
                    <div class="detail-branch-header" style="grid-template-columns: 2fr 1fr 1fr 1fr 1fr;">
                        <div>Branch</div>
                        <div>Region</div>
                        <div style="color:#6366F1;">FIG/IGL</div>
                        <div style="color:#F59E0B;">IL</div>
                        <div style="color:#10B981;">NPA</div>
                    </div>
                    ${kycData.map(b => `
                        <div class="detail-branch-row" style="grid-template-columns: 2fr 1fr 1fr 1fr 1fr;">
                            <div class="detail-branch-name">${b.name}</div>
                            <div>${b.region}</div>
                            <div style="font-weight:600; color:#6366F1;">${b.figIgl}</div>
                            <div style="font-weight:600; color:#F59E0B;">${b.il}</div>
                            <div style="font-weight:600; color:#10B981;">${b.npa}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // ============ HELPER FUNCTIONS FOR DETAIL VIEWS ============

        function getBranchListByStatus() {
            const branches = [];
            const idxBranch = state.rawData.headers.findIndex(h => h.trim().toLowerCase() === 'branch');
            const idxDistrict = state.rawData.headers.findIndex(h => h.trim().toLowerCase() === 'district');
            const idxDM = state.rawData.headers.findIndex(h => h.trim().toLowerCase() === 'dm name');
            const idxRegion = state.rawData.headers.findIndex(h => h.trim().toLowerCase() === 'region');

            state.rawData.rows.forEach(row => {
                const name = row[idxBranch];
                if (!name) return;

                const entry = state.branchDetails[name];
                const hasTarget = entry && entry.target;
                const hasAchieve = entry && entry.achievement;

                let status = 'nodata';
                let statusLabel = 'No Data';
                let statusColor = '#EF4444';

                if (hasTarget && hasAchieve) {
                    status = 'completed';
                    statusLabel = 'Completed';
                    statusColor = '#10B981';
                } else if (hasTarget) {
                    status = 'pending';
                    statusLabel = 'Pending';
                    statusColor = '#F59E0B';
                }

                const pctVal = calculateBranchAveragePercentage(name);
                const pct = pctVal !== null ? pctVal + '%' : '--';
                let pctColor = '#6B7280';
                if (pctVal !== null) {
                    pctColor = pctVal >= 100 ? '#10B981' : pctVal >= 50 ? '#F59E0B' : '#EF4444';
                }

                branches.push({
                    name,
                    district: row[idxDistrict] || '',
                    dm: row[idxDM] || '',
                    region: row[idxRegion] || '',
                    status,
                    statusLabel,
                    statusColor,
                    pct,
                    pctColor,
                    pctVal: pctVal || 0
                });
            });

            return branches;
        }

        function getRegionBreakdown() {
            const regions = {};
            const idxBranch = state.rawData.headers.findIndex(h => h.trim().toLowerCase() === 'branch');
            const idxRegion = state.rawData.headers.findIndex(h => h.trim().toLowerCase() === 'region');

            state.rawData.rows.forEach(row => {
                const branch = row[idxBranch];
                const region = row[idxRegion];
                if (!branch || !region) return;

                if (!regions[region]) regions[region] = { branches: 0, completed: 0 };
                regions[region].branches++;

                const entry = state.branchDetails[branch];
                if (entry && entry.target && entry.achievement) {
                    regions[region].completed++;
                }
            });

            Object.keys(regions).forEach(r => {
                regions[r].completionPct = regions[r].branches > 0
                    ? Math.round((regions[r].completed / regions[r].branches) * 100)
                    : 0;
            });

            return regions;
        }

        function getUniqueDMs() {
            const idx = state.rawData.headers.findIndex(h => h.trim().toLowerCase() === 'dm name');
            const dms = new Set(state.rawData.rows.map(r => r[idx]).filter(Boolean));
            return dms.size;
        }

        function getUniqueDistricts() {
            const idx = state.rawData.headers.findIndex(h => h.trim().toLowerCase() === 'district');
            const districts = new Set(state.rawData.rows.map(r => r[idx]).filter(Boolean));
            return districts.size;
        }

        function getRankedBranches() {
            const branches = getBranchListByStatus();
            return branches.filter(b => b.status === 'completed' && b.pctVal > 0).sort((a, b) => b.pctVal - a.pctVal);
        }

        function getBranchNPAData() {
            const data = [];
            const idxBranch = state.rawData.headers.findIndex(h => h.trim().toLowerCase() === 'branch');
            const idxRegion = state.rawData.headers.findIndex(h => h.trim().toLowerCase() === 'region');

            state.rawData.rows.forEach(row => {
                const name = row[idxBranch];
                const region = row[idxRegion];
                if (!name) return;

                const entry = state.branchDetails[name];
                if (entry && entry.achievement) {
                    const activation = parseInt(entry.achievement.npa_activation) || 0;
                    const closure = parseInt(entry.achievement.npa_closure) || 0;
                    data.push({ name, region, activation, closure, net: activation - closure });
                }
            });

            return data.sort((a, b) => b.net - a.net);
        }

        function getPortfolioBreakdown() {
            const data = [];
            const idxBranch = state.rawData.headers.findIndex(h => h.trim().toLowerCase() === 'branch');
            const idxRegion = state.rawData.headers.findIndex(h => h.trim().toLowerCase() === 'region');

            state.rawData.rows.forEach(row => {
                const name = row[idxBranch];
                const region = row[idxRegion];
                if (!name) return;

                const entry = state.branchDetails[name];
                if (entry && entry.achievement) {
                    data.push({
                        name,
                        region,
                        healthy: parseInt(entry.achievement.ftod_actual) || 0,
                        slipped: parseInt(entry.achievement.lived_actual) || 0,
                        pnpa: parseInt(entry.achievement.pnpa_actual) || 0
                    });
                }
            });

            return data;
        }

        function getDisbursementByProduct(accField, amtField) {
            const data = [];
            const idxBranch = state.rawData.headers.findIndex(h => h.trim().toLowerCase() === 'branch');
            const idxRegion = state.rawData.headers.findIndex(h => h.trim().toLowerCase() === 'region');

            state.rawData.rows.forEach(row => {
                const name = row[idxBranch];
                const region = row[idxRegion];
                if (!name) return;

                const entry = state.branchDetails[name];
                if (entry && entry.achievement) {
                    const accounts = parseInt(entry.achievement[accField]) || 0;
                    const amount = parseInt(entry.achievement[amtField]) || 0;
                    if (accounts > 0 || amount > 0) {
                        data.push({ name, region, accounts, amount });
                    }
                }
            });

            return data.sort((a, b) => b.amount - a.amount);
        }

        function getBranchesByRegion(regionName) {
            const branches = getBranchListByStatus();
            return branches.filter(b => b.region === regionName);
        }

        function getKYCBreakdown() {
            const data = [];
            const idxBranch = state.rawData.headers.findIndex(h => h.trim().toLowerCase() === 'branch');
            const idxRegion = state.rawData.headers.findIndex(h => h.trim().toLowerCase() === 'region');

            state.rawData.rows.forEach(row => {
                const name = row[idxBranch];
                const region = row[idxRegion];
                if (!name) return;

                const entry = state.branchDetails[name];
                if (entry && entry.achievement) {
                    data.push({
                        name,
                        region,
                        figIgl: parseInt(entry.achievement.kyc_fig_igl) || 0,
                        il: parseInt(entry.achievement.kyc_il) || 0,
                        npa: parseInt(entry.achievement.kyc_npa) || 0
                    });
                }
            });

            return data;
        }

        function renderMetricBranchTable(metricType, stats) {
            const config = {
                'ftod': { targetField: 'ftod_plan', achieveField: 'ftod_actual', label: 'FTOD' },
                'slipped': { targetField: 'lived_plan', achieveField: 'lived_actual', label: 'Slipped' },
                'pnpa': { targetField: 'pnpa_plan', achieveField: 'pnpa_actual', label: 'PNPA' },
                'collection': { targetField: null, achieveField: null, label: 'All' }
            };

            const cfg = config[metricType] || config['collection'];
            const data = [];
            const idxBranch = state.rawData.headers.findIndex(h => h.trim().toLowerCase() === 'branch');
            const idxRegion = state.rawData.headers.findIndex(h => h.trim().toLowerCase() === 'region');

            state.rawData.rows.forEach(row => {
                const name = row[idxBranch];
                const region = row[idxRegion];
                if (!name) return;

                const entry = state.branchDetails[name];
                if (entry && entry.target && entry.achievement) {
                    let target, achieve;
                    if (cfg.targetField) {
                        target = parseInt(entry.target[cfg.targetField]) || 0;
                        achieve = parseInt(entry.achievement[cfg.achieveField]) || 0;
                    } else {
                        target = (parseInt(entry.target.ftod_plan) || 0) + (parseInt(entry.target.lived_plan) || 0) + (parseInt(entry.target.pnpa_plan) || 0);
                        achieve = (parseInt(entry.achievement.ftod_actual) || 0) + (parseInt(entry.achievement.lived_actual) || 0) + (parseInt(entry.achievement.pnpa_actual) || 0);
                    }

                    const pct = target > 0 ? Math.round((achieve / target) * 100) : 0;
                    data.push({ name, region, target, achieve, pct });
                }
            });

            data.sort((a, b) => a.pct - b.pct);

            return `
                <div class="detail-branch-list">
                    <div class="detail-branch-header" style="grid-template-columns: 2fr 1fr 1fr 1fr 1fr;">
                        <div>Branch</div>
                        <div>Region</div>
                        <div>Target</div>
                        <div>Achievement</div>
                        <div>%</div>
                    </div>
                    ${data.map(b => {
                const pctColor = b.pct >= 100 ? '#10B981' : b.pct >= 50 ? '#F59E0B' : '#EF4444';
                return `
                            <div class="detail-branch-row" style="grid-template-columns: 2fr 1fr 1fr 1fr 1fr;">
                                <div class="detail-branch-name">${b.name}</div>
                                <div>${b.region}</div>
                                <div>${b.target.toLocaleString()}</div>
                                <div style="font-weight:600;">${b.achieve.toLocaleString()}</div>
                                <div>
                                    <span class="detail-pct-badge" style="background:${pctColor}20; color:${pctColor};">${b.pct}%</span>
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `;
        }

        function renderDisbursementBranchTable(stats) {
            const data = [];
            const idxBranch = state.rawData.headers.findIndex(h => h.trim().toLowerCase() === 'branch');
            const idxRegion = state.rawData.headers.findIndex(h => h.trim().toLowerCase() === 'region');

            state.rawData.rows.forEach(row => {
                const name = row[idxBranch];
                const region = row[idxRegion];
                if (!name) return;

                const entry = state.branchDetails[name];
                if (entry && entry.achievement) {
                    const a = entry.achievement;
                    const total = (parseInt(a.disb_sanc_pent_amt) || 0) + (parseInt(a.disb_igl_amt) || 0) + (parseInt(a.disb_il_amt) || 0);
                    if (total > 0) {
                        data.push({
                            name,
                            region,
                            sanction: (parseInt(a.disb_sanc_pent_amt) || 0),
                            igl: (parseInt(a.disb_igl_amt) || 0),
                            il: (parseInt(a.disb_il_amt) || 0),
                            total
                        });
                    }
                }
            });

            data.sort((a, b) => b.total - a.total);

            return `
                <div class="detail-branch-list">
                    <div class="detail-branch-header" style="grid-template-columns: 2fr 1fr 1fr 1fr 1fr;">
                        <div>Branch</div>
                        <div>Sanction (â‚¹L)</div>
                        <div>IGL (â‚¹L)</div>
                        <div>IL (â‚¹L)</div>
                        <div>Total (â‚¹L)</div>
                    </div>
                    ${data.map(b => `
                        <div class="detail-branch-row" style="grid-template-columns: 2fr 1fr 1fr 1fr 1fr;">
                            <div>
                                <div class="detail-branch-name">${b.name}</div>
                                <div class="detail-branch-region">${b.region}</div>
                            </div>
                            <div>${(b.sanction / 100000).toFixed(1)}</div>
                            <div>${(b.igl / 100000).toFixed(1)}</div>
                            <div>${(b.il / 100000).toFixed(1)}</div>
                            <div style="font-weight:700; color:var(--primary-accent);">${(b.total / 100000).toFixed(1)}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Filter functions for detail views
        function filterBranchList(filter) {
            document.querySelectorAll('.detail-filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            document.querySelectorAll('#branchListContainer .detail-branch-row').forEach(row => {
                const status = row.dataset.status;
                if (filter === 'all' || status === filter) {
                    row.style.display = 'grid';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function filterPortfolio(filter) {
            document.querySelectorAll('.detail-filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            // For now just visual feedback, could implement actual filtering
        }
    </script>
</body>

</html>